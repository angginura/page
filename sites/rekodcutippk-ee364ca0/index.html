<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Rekod Cuti - Unit Hemodialisis Hospital Bintulu</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://i.postimg.cc/595wB3cy/HOSPITAL_BINTULU.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- JSPDF for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#f97316', // Orange-500
                        secondary: '#c2410c', // Orange-700
                        darkbg: '#1f2937',
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #ea580c; border-radius: 4px; }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }
        .dark .glass-effect {
            background: rgba(31, 41, 55, 0.9);
        }
        
        /* Print Styles */
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; color: black; }
        }
        
        /* Footer fixed at bottom specific styling */
        .footer-text {
            font-size: 0.75rem;
            color: #6b7280;
            text-align: center;
            padding: 1rem;
            width: 100%;
        }
        .dark .footer-text {
            color: #9ca3af;
        }
    </style>
</head>
<body class="bg-orange-50 text-gray-800 font-sans transition-colors duration-300 flex flex-col min-h-screen">

    <!-- Notifications -->
    <div id="toast-container" class="fixed top-5 right-5 z-50 flex flex-col gap-2"></div>

    <!-- Invisible image for PDF generation canvas -->
    <img id="logo-hidden" src="https://i.postimg.cc/595wB3cy/HOSPITAL_BINTULU.png" crossorigin="anonymous" class="hidden">

    <!-- MAIN APP CONTAINER -->
    <div id="app" class="flex-1 flex flex-col overflow-hidden h-screen">
        
        <!-- LOADING SCREEN -->
        <div id="loading" class="hidden fixed inset-0 bg-black/50 z-[60] flex flex-col items-center justify-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-primary border-white"></div>
            <p class="text-white mt-4 font-bold animate-pulse" id="loading-text">Memproses Data...</p>
        </div>

        <!-- CUSTOM CONFIRMATION MODAL -->
        <div id="confirm-modal" class="hidden fixed inset-0 bg-black/60 z-[70] flex items-center justify-center backdrop-blur-sm">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-6 max-w-sm w-full transform scale-100 transition-all">
                <div class="text-center">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 dark:bg-red-900 mb-4">
                        <i class="fas fa-exclamation-triangle text-red-600 dark:text-red-400 text-xl"></i>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white" id="modal-title">Padam Rekod?</h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-2" id="modal-message">Adakah anda pasti mahu memadam rekod ini? Tindakan ini tidak boleh dikembalikan.</p>
                </div>
                <div class="mt-6 flex gap-3">
                    <button id="btn-modal-cancel" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg transition">Batal</button>
                    <button id="btn-modal-confirm" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition shadow-lg">Padam</button>
                </div>
            </div>
        </div>

        <!-- VIEW: LOGIN & PUBLIC CHECK -->
        <div id="login-view" class="flex-1 flex flex-col items-center justify-center p-4 bg-[url('https://i.postimg.cc/wBCWvCgN/Hemodialysis-Machine.jpg')] bg-cover bg-center relative overflow-y-auto">
            <div class="absolute inset-0 bg-orange-50/20 backdrop-blur-[2px]"></div>
            
            <div class="z-10 bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-4xl flex flex-col md:flex-row gap-8 transition-colors duration-300 mt-10 mb-10">
                
                <!-- Logo & Intro -->
                <div class="flex-1 flex flex-col items-center justify-center text-center border-b md:border-b-0 md:border-r border-gray-200 dark:border-gray-700 pr-0 md:pr-8 pb-8 md:pb-0">
                    <img src="https://i.postimg.cc/595wB3cy/HOSPITAL_BINTULU.png" alt="Logo Hospital" class="w-32 h-32 mb-4 drop-shadow-lg">
                    <h1 class="text-2xl font-bold text-orange-600 dark:text-orange-400">UNIT HEMODIALISIS</h1>
                    <h2 class="text-xl font-bold text-gray-700 dark:text-gray-200">HOSPITAL BINTULU</h2>
                    <p class="mt-2 text-lg font-bold text-gray-600 dark:text-gray-300">Rekod Cuti & Hari Kelepasan Am</p>
                    <p class="text-sm font-semibold text-gray-500 dark:text-gray-400 mt-1">Pembantu Perawatan Kesihatan & Penolong Pegawai Perubatan</p>
                </div>

                <!-- Forms Container -->
                <div class="flex-1 flex flex-col gap-6">
                    
                    <!-- Toggle Buttons -->
                    <div class="flex bg-gray-100 dark:bg-gray-700 rounded-lg p-1">
                        <button onclick="switchLoginTab('admin')" id="btn-tab-admin" class="flex-1 py-2 rounded-md text-sm font-medium bg-white dark:bg-gray-600 shadow text-primary transition-all">Admin Panel</button>
                        <button onclick="switchLoginTab('public')" id="btn-tab-public" class="flex-1 py-2 rounded-md text-sm font-medium text-gray-500 dark:text-gray-300 hover:text-gray-700 transition-all">Semak Rekod</button>
                    </div>

                    <!-- Admin Login Form -->
                    <form id="admin-login-form" onsubmit="handleLogin(event)" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Email</label>
                            <div class="relative mt-1">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-orange-500"><i class="fas fa-envelope"></i></span>
                                <input type="email" id="login-email" required class="pl-10 w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:ring-primary focus:border-primary py-2 border shadow-sm transition-all hover:border-orange-400">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Password</label>
                            <div class="relative mt-1">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-orange-500"><i class="fas fa-lock"></i></span>
                                <input type="password" id="login-password" required class="pl-10 w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:ring-primary focus:border-primary py-2 border shadow-sm transition-all hover:border-orange-400">
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-gradient-to-r from-orange-500 to-red-600 hover:from-orange-600 hover:to-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition transform hover:scale-[1.02]">
                            <i class="fas fa-sign-in-alt mr-2"></i> Daftar Masuk
                        </button>
                    </form>

                    <!-- Public Check Form -->
                    <form id="public-check-form" onsubmit="handlePublicCheck(event)" class="space-y-4 hidden">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">No. Kad Pengenalan</label>
                            <div class="relative mt-1">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-blue-500"><i class="fas fa-id-card"></i></span>
                                <input type="text" id="check-ic" required class="pl-10 w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:ring-primary focus:border-primary py-2 border shadow-sm transition-all hover:border-blue-400">
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition transform hover:scale-[1.02]">
                            <i class="fas fa-search mr-2"></i> Semak Rekod Cuti
                        </button>
                    </form>

                </div>
            </div>
            
            <!-- FOOTER IN LOGIN PAGE -->
            <div class="z-10 mt-auto pb-4">
                 <p class="text-white text-xs drop-shadow-md bg-black/30 px-3 py-1 rounded-full backdrop-blur-sm">@ <span class="year-display"></span> Rekod Cuti Pembantu Perawatan Kesihatan</p>
            </div>
        </div>

        <!-- VIEW: ADMIN DASHBOARD LAYOUT -->
        <div id="admin-view" class="hidden flex h-full bg-gray-50 dark:bg-gray-900">
            
            <!-- Sidebar -->
            <aside class="w-64 bg-orange-800 text-white flex flex-col shadow-xl transition-all duration-300 z-30" id="sidebar">
                <div class="p-6 flex flex-col items-center border-b border-orange-700">
                    <img src="https://i.postimg.cc/595wB3cy/HOSPITAL_BINTULU.png" alt="Logo" class="w-16 h-16 mb-2 bg-white rounded-full p-1 shadow-md">
                    <span class="font-bold text-lg tracking-wide">ADMIN PANEL</span>
                    <span class="text-xs text-orange-200">Unit Hemodialisis</span>
                </div>

                <nav class="flex-1 overflow-y-auto py-4">
                    <ul class="space-y-1">
                        <li><a href="#" onclick="showPage('dashboard')" class="nav-item block py-3 px-6 hover:bg-orange-700 transition border-l-4 border-transparent hover:border-white text-sm"><i class="fas fa-tachometer-alt w-6 text-yellow-300"></i> Dashboard</a></li>
                        <li><a href="#" onclick="showPage('registration')" class="nav-item block py-3 px-6 hover:bg-orange-700 transition border-l-4 border-transparent hover:border-white text-sm"><i class="fas fa-user-plus w-6 text-blue-300"></i> Pendaftaran Pegawai</a></li>
                        <li><a href="#" onclick="showPage('check-records')" class="nav-item block py-3 px-6 hover:bg-orange-700 transition border-l-4 border-transparent hover:border-white text-sm"><i class="fas fa-search-plus w-6 text-purple-300"></i> Semakan Rekod Pegawai</a></li>
                        <li><a href="#" onclick="showPage('leave-record')" class="nav-item block py-3 px-6 hover:bg-orange-700 transition border-l-4 border-transparent hover:border-white text-sm"><i class="fas fa-calendar-check w-6 text-green-300"></i> Rekod Cuti Tahunan</a></li>
                        <li><a href="#" onclick="showPage('ph-config')" class="nav-item block py-3 px-6 hover:bg-orange-700 transition border-l-4 border-transparent hover:border-white text-sm"><i class="fas fa-calendar-day w-6 text-red-300"></i> Jenis Hari Kelepasan</a></li>
                        <li><a href="#" onclick="showPage('ph-record')" class="nav-item block py-3 px-6 hover:bg-orange-700 transition border-l-4 border-transparent hover:border-white text-sm"><i class="fas fa-umbrella-beach w-6 text-pink-300"></i> Rekod Cuti Am</a></li>
                        <li><a href="#" onclick="showPage('admin-reg')" class="nav-item block py-3 px-6 hover:bg-orange-700 transition border-l-4 border-transparent hover:border-white text-sm"><i class="fas fa-user-shield w-6 text-gray-300"></i> Daftar Admin</a></li>
                    </ul>
                </nav>

                <div class="p-4 border-t border-orange-700">
                    <button onclick="toggleDarkMode()" class="flex items-center text-sm text-orange-200 hover:text-white mb-4 transition-colors">
                        <i class="fas fa-moon w-6 text-yellow-200"></i> Mod Gelap/Cerah
                    </button>
                    <button onclick="logout()" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 rounded shadow flex items-center justify-center transition-transform hover:scale-105">
                        <i class="fas fa-sign-out-alt mr-2"></i> Log Keluar
                    </button>
                </div>
            </aside>

            <!-- Main Content Area -->
            <main class="flex-1 flex flex-col overflow-hidden relative">
                <!-- Header Mobile -->
                <header class="bg-white dark:bg-gray-800 shadow p-4 flex justify-between md:hidden z-20">
                    <span class="font-bold text-primary flex items-center gap-2"><i class="fas fa-hospital-user text-orange-600"></i> Sistem Cuti</span>
                    <button onclick="document.getElementById('sidebar').classList.toggle('-translate-x-full absolute h-full')" class="text-gray-600 dark:text-white"><i class="fas fa-bars"></i></button>
                </header>

                <div id="page-content" class="flex-1 overflow-y-auto p-6 md:p-8 pb-16">
                    <!-- Dynamic Content Loaded Here via JS -->
                </div>

                <!-- Footer In Admin Panel -->
                <footer class="footer-text bg-white dark:bg-gray-800 border-t dark:border-gray-700">
                    @ <span class="year-display"></span> Rekod Cuti Pembantu Perawatan Kesihatan
                </footer>
            </main>
        </div>

        <!-- VIEW: PUBLIC RESULT MODAL -->
        <div id="public-view" class="hidden fixed inset-0 bg-black/50 z-50 overflow-y-auto backdrop-blur-sm">
            <div class="min-h-screen px-4 text-center">
                <span class="inline-block h-screen align-middle" aria-hidden="true">&#8203;</span>
                <div class="inline-block w-full max-w-5xl p-6 my-8 text-left align-middle transition-all transform bg-white dark:bg-gray-800 shadow-xl rounded-2xl relative border-t-4 border-primary">
                    <button onclick="closePublicView()" class="absolute top-4 right-4 text-gray-500 hover:text-red-500 text-2xl"><i class="fas fa-times"></i></button>
                    
                    <div id="public-result-content">
                        <!-- Content Injected -->
                    </div>

                     <!-- Footer In Modal -->
                    <div class="text-center mt-6 text-xs text-gray-500">
                        @ <span class="year-display"></span> Rekod Cuti Pembantu Perawatan Kesihatan
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- GOOGLE APPS SCRIPT CONFIG ---
        const GAS_URL = "https://script.google.com/macros/s/AKfycbw1J1Gbo0fsJ4vh11jp41_1_Sk6iz0zjbQOpX3xaGLBWOcX14iUJyn-9OzOnk4wEgWWRQ/exec";
        
        // --- GLOBAL STATE ---
        let currentUser = null;
        let currentYear = new Date().getFullYear();
        let currentPublicTab = 'annual';
        let currentAdminReportTab = 'annual';
        let currentAdminViewIC = null; 
        
        // Cached Data
        let globalStaff = [];
        let globalLeaves = [];
        let globalHolidays = [];
        let globalPHTaken = [];
        let globalUsers = [];

        // --- API HANDLER ---
        async function callApi(action, payload = {}) {
            showLoading(true);
            const params = new URLSearchParams();
            params.append('action', action);
            for (const key in payload) {
                if (typeof payload[key] === 'object') {
                    params.append(key, JSON.stringify(payload[key]));
                } else {
                    params.append(key, payload[key]);
                }
            }

            try {
                console.log("Calling API:", action); 
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    body: params
                });
                
                if (!response.ok) throw new Error("Ralat Rangkaian");
                
                const json = await response.json();
                
                showLoading(false);
                if (!json.success) {
                    throw new Error(json.message || "Ralat tidak diketahui");
                }
                return json;
            } catch (error) {
                showLoading(false);
                showToast(`Ralat: ${error.message}`, 'error');
                console.error(error);
                return null;
            }
        }

        function showLoading(isLoading) {
            const el = document.getElementById('loading');
            if(isLoading) el.classList.remove('hidden');
            else el.classList.add('hidden');
        }

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', () => {
            initSystem();
            updateYearDisplays();
        });

        async function initSystem() {
            const res = await callApi('get_all_data');
            if (res && res.data) {
                globalStaff = res.data.staff || [];
                globalLeaves = res.data.leaves || [];
                globalHolidays = res.data.holidays || [];
                globalPHTaken = res.data.phTaken || [];
                globalUsers = res.data.users || [];
                
                if(globalUsers.length === 0) {
                    globalUsers = [{ email: 'rickeers@moh.gov.my', pass: '135881Andres@', name: 'Master Admin' }];
                }
            }
        }

        function updateYearDisplays() {
            const yearSpans = document.querySelectorAll('.year-display');
            yearSpans.forEach(span => {
                span.innerText = currentYear;
            });
        }

        // --- MODAL UTILS ---
        let confirmCallback = null;

        function showConfirmModal(title, message, callback) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-message').innerText = message;
            confirmCallback = callback;
            document.getElementById('confirm-modal').classList.remove('hidden');
        }

        document.getElementById('btn-modal-cancel').addEventListener('click', () => {
            document.getElementById('confirm-modal').classList.add('hidden');
            confirmCallback = null;
        });

        document.getElementById('btn-modal-confirm').addEventListener('click', () => {
            if (confirmCallback) confirmCallback();
            document.getElementById('confirm-modal').classList.add('hidden');
            confirmCallback = null;
        });

        // --- AUTH FUNCTIONS ---
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-password').value;
            const user = globalUsers.find(u => u.email === email && u.pass === pass);
            
            if (user) {
                currentUser = user;
                showToast('Log masuk berjaya!', 'success');
                document.getElementById('login-view').classList.add('hidden');
                document.getElementById('admin-view').classList.remove('hidden');
                document.getElementById('admin-view').classList.add('flex');
                showPage('dashboard');
            } else {
                showToast('Email atau kata laluan salah.', 'error');
            }
        }

        function logout() {
            currentUser = null;
            document.getElementById('admin-view').classList.add('hidden');
            document.getElementById('admin-view').classList.remove('flex');
            document.getElementById('login-view').classList.remove('hidden');
            document.getElementById('admin-login-form').reset();
        }

        function switchLoginTab(tab) {
            const btnAdmin = document.getElementById('btn-tab-admin');
            const btnPublic = document.getElementById('btn-tab-public');
            const formAdmin = document.getElementById('admin-login-form');
            const formPublic = document.getElementById('public-check-form');

            if (tab === 'admin') {
                btnAdmin.classList.add('bg-white', 'shadow', 'text-primary');
                btnAdmin.classList.remove('text-gray-500');
                btnPublic.classList.remove('bg-white', 'shadow', 'text-primary');
                btnPublic.classList.add('text-gray-500');
                formAdmin.classList.remove('hidden');
                formPublic.classList.add('hidden');
            } else {
                btnPublic.classList.add('bg-white', 'shadow', 'text-primary');
                btnPublic.classList.remove('text-gray-500');
                btnAdmin.classList.remove('bg-white', 'shadow', 'text-primary');
                btnAdmin.classList.add('text-gray-500');
                formPublic.classList.remove('hidden');
                formAdmin.classList.add('hidden');
            }
        }

        // --- PUBLIC CHECK ---
        function handlePublicCheck(e) {
            e.preventDefault();
            const ic = document.getElementById('check-ic').value;
            const person = globalStaff.find(s => s.ic === ic);

            if (person) {
                renderPublicReport(person);
                document.getElementById('public-view').classList.remove('hidden');
            } else {
                showToast('Tiada rekod dijumpai untuk No KP tersebut.', 'error');
            }
        }

        function closePublicView() {
            document.getElementById('public-view').classList.add('hidden');
        }

        // --- ADMIN NAVIGATION ---
        function showPage(pageId) {
            // Update Active Link
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('bg-orange-700', 'border-white');
                el.classList.add('border-transparent');
            });
            
            const container = document.getElementById('page-content');
            container.innerHTML = ''; 

            switch(pageId) {
                case 'dashboard': renderDashboard(container); break;
                case 'registration': renderRegistration(container); break;
                case 'check-records': renderCheckRecords(container); break;
                case 'leave-record': renderLeaveRecord(container); break;
                case 'ph-config': renderPhConfig(container); break;
                case 'ph-record': renderPhRecord(container); break;
                case 'admin-reg': renderAdminReg(container); break;
            }
        }

        // --- DASHBOARD ---
        async function renderDashboard(container) {
            await initSystem();
            const totalStaff = globalStaff.length;
            const today = new Date().toISOString().split('T')[0];
            const leavesToday = globalLeaves.filter(l => l.startDate <= today && l.endDate >= today).length;
            const totalLeavesTaken = globalLeaves.length;

            container.innerHTML = `
                <h2 class="text-3xl font-bold text-gray-800 dark:text-white mb-6 flex items-center gap-3">
                    <i class="fas fa-tachometer-alt text-yellow-500"></i> Dashboard <span class="text-sm font-normal text-gray-500">Rumusan</span>
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md border-l-4 border-primary hover:shadow-xl transition-all">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Jumlah Pegawai</p>
                                <p class="text-2xl font-bold text-gray-800 dark:text-white">${totalStaff}</p>
                            </div>
                            <div class="bg-orange-100 p-3 rounded-full text-primary"><i class="fas fa-users text-xl"></i></div>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md border-l-4 border-green-500 hover:shadow-xl transition-all">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Sedang Bercuti Hari Ini</p>
                                <p class="text-2xl font-bold text-gray-800 dark:text-white">${leavesToday}</p>
                            </div>
                            <div class="bg-green-100 p-3 rounded-full text-green-600"><i class="fas fa-user-clock text-xl"></i></div>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md border-l-4 border-blue-500 hover:shadow-xl transition-all">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Jumlah Permohonan Cuti</p>
                                <p class="text-2xl font-bold text-gray-800 dark:text-white">${totalLeavesTaken}</p>
                            </div>
                            <div class="bg-blue-100 p-3 rounded-full text-blue-600"><i class="fas fa-file-alt text-xl"></i></div>
                        </div>
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                   <h3 class="text-lg font-bold mb-4 dark:text-white flex items-center gap-2"><i class="fas fa-cog text-gray-500"></i> Tetapan Tahun Semasa</h3>
                   <div class="flex items-center gap-4">
                        <input type="number" id="system-year" value="${currentYear}" class="border rounded p-2 dark:bg-gray-700 dark:text-white focus:ring-primary focus:border-primary" onchange="changeYear(this.value)">
                        <span class="text-sm text-gray-500">Tukar tahun untuk melihat/menambah rekod tahun hadapan.</span>
                   </div>
                </div>
            `;
        }

        function changeYear(val) {
            currentYear = val;
            updateYearDisplays();
            showToast('Tahun ditukar ke ' + val);
        }

        // --- REGISTRATION ---
        function renderRegistration(container) {
            const groupedStaff = {};
            globalStaff.forEach(s => {
                if(!groupedStaff[s.position]) groupedStaff[s.position] = [];
                groupedStaff[s.position].push(s);
            });

            let staffListHtml = '';
            for (const [position, staff] of Object.entries(groupedStaff)) {
                staffListHtml += `
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg max-w-4xl mx-auto mb-6">
                        <h3 class="text-lg font-bold text-primary dark:text-orange-400 mb-4 border-b pb-2 flex items-center gap-2">
                             <i class="fas fa-briefcase text-blue-400"></i> ${position}
                        </h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left dark:text-gray-300">
                                <thead class="bg-gray-100 dark:bg-gray-700 uppercase text-xs font-bold">
                                    <tr>
                                        <th class="px-4 py-3">Nama</th>
                                        <th class="px-4 py-3">No. KP</th>
                                        <th class="px-4 py-3">Gred</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${staff.map(s => `
                                        <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors">
                                            <td class="px-4 py-2 font-medium text-gray-900 dark:text-white">${s.name}</td>
                                            <td class="px-4 py-2">${s.ic}</td>
                                            <td class="px-4 py-2">${s.grade}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }

            if (Object.keys(groupedStaff).length === 0) {
                staffListHtml = `
                    <div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-lg max-w-4xl mx-auto text-center text-gray-500">
                        Tiada pegawai didaftarkan.
                    </div>
                `;
            }

            container.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-lg max-w-2xl mx-auto mb-8">
                    <h2 class="text-2xl font-bold text-primary mb-6 flex items-center gap-2"><i class="fas fa-user-plus text-blue-500"></i> Pendaftaran Pegawai</h2>
                    <form onsubmit="registerStaff(event)" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium dark:text-gray-300">Nama Penuh</label>
                            <input type="text" name="name" required class="w-full border rounded-lg p-2 dark:bg-gray-700 dark:text-white border-gray-300 dark:border-gray-600 focus:ring-primary focus:border-primary">
                        </div>
                        <div>
                            <label class="block text-sm font-medium dark:text-gray-300">No. Kad Pengenalan</label>
                            <input type="text" name="ic" required class="w-full border rounded-lg p-2 dark:bg-gray-700 dark:text-white border-gray-300 dark:border-gray-600 focus:ring-primary focus:border-primary">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium dark:text-gray-300">Jawatan</label>
                                <select name="position" class="w-full border rounded-lg p-2 dark:bg-gray-700 dark:text-white border-gray-300 dark:border-gray-600 focus:ring-primary focus:border-primary">
                                    <option>Pembantu Perawatan Kesihatan</option>
                                    <option>Penolong Pegawai Perubatan</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium dark:text-gray-300">Gred Jawatan</label>
                                <select name="grade" class="w-full border rounded-lg p-2 dark:bg-gray-700 dark:text-white border-gray-300 dark:border-gray-600 focus:ring-primary focus:border-primary">
                                    <option>U1</option>
                                    <option>U2</option>
                                    <option>U5</option>
                                    <option>U6</option>
                                    <option>U7</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-primary hover:bg-secondary text-white font-bold py-2 rounded-lg transition transform hover:scale-105">Simpan Rekod</button>
                    </form>
                </div>

                <div class="max-w-4xl mx-auto mb-4">
                    <h3 class="text-xl font-bold text-gray-700 dark:text-white flex items-center gap-2"><i class="fas fa-list text-gray-500"></i> Senarai Pegawai Berdaftar</h3>
                </div>
                ${staffListHtml}
            `;
        }

        async function registerStaff(e) {
            e.preventDefault();
            const form = e.target;
            const newStaff = {
                id: Date.now().toString(),
                name: form.name.value,
                ic: form.ic.value,
                position: form.position.value,
                grade: form.grade.value,
                entitlements: {} 
            };
            const res = await callApi('add_staff', { staff: newStaff });
            if (res) {
                showToast('Pegawai berjaya didaftarkan!', 'success');
                form.reset();
                initSystem().then(() => showPage('registration'));
            }
        }

        // --- CHECK RECORDS (ADMIN) ---
        function renderCheckRecords(container) {
             const positions = [...new Set(globalStaff.map(s => s.position))];

             container.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-lg max-w-5xl mx-auto">
                     <h2 class="text-2xl font-bold text-primary mb-6 flex items-center gap-2"><i class="fas fa-search-plus text-purple-500"></i> Semakan Rekod Pegawai</h2>
                     
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium dark:text-gray-300 mb-2">Pilih Jawatan</label>
                            <select id="check-pos-select" onchange="filterCheckStaffByPos(this.value)" class="w-full border rounded-lg p-2 dark:bg-gray-700 dark:text-white border-gray-300 dark:border-gray-600 focus:ring-primary focus:border-primary">
                                <option value="">-- Sila Pilih Jawatan --</option>
                                ${positions.map(p => `<option value="${p}">${p}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium dark:text-gray-300 mb-2">Pilih Pegawai</label>
                            <select id="check-staff-select" onchange="loadAdminReport(this.value)" class="w-full border rounded-lg p-2 dark:bg-gray-700 dark:text-white border-gray-300 dark:border-gray-600 focus:ring-primary focus:border-primary">
                                <option value="">-- Sila Pilih Nama --</option>
                            </select>
                        </div>
                     </div>

                     <div id="admin-report-container" class="border rounded-lg p-4 min-h-[400px] bg-gray-50 dark:bg-gray-900 dark:border-gray-700">
                        <p class="text-center text-gray-500 py-20">Sila pilih pegawai di atas untuk melihat laporan.</p>
                     </div>
                </div>
             `;
        }

        function filterCheckStaffByPos(position) {
            const nameSelect = document.getElementById('check-staff-select');
            nameSelect.innerHTML = '<option value="">-- Sila Pilih Nama --</option>';
            document.getElementById('admin-report-container').innerHTML = `<p class="text-center text-gray-500 py-20">Sila pilih pegawai di atas untuk melihat laporan.</p>`;

            if (!position) return;
            const filteredStaff = globalStaff.filter(s => s.position === position);
            filteredStaff.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.ic;
                opt.innerText = s.name;
                nameSelect.appendChild(opt);
            });
        }

        function loadAdminReport(ic) {
            const container = document.getElementById('admin-report-container');
            if(!ic) {
                container.innerHTML = `<p class="text-center text-gray-500 py-20">Sila pilih pegawai di atas untuk melihat laporan.</p>`;
                return;
            }

            currentAdminViewIC = ic;
            const person = globalStaff.find(s => s.ic === ic);
            const leaves = globalLeaves.filter(l => l.ic === person.ic && l.year == currentYear)
                .sort((a,b) => new Date(a.startDate) - new Date(b.startDate));
            const phTaken = globalPHTaken.filter(p => p.ic === person.ic && p.year == currentYear);

            if (typeof person.entitlements === 'string') {
                try { person.entitlements = JSON.parse(person.entitlements); } catch(e){ person.entitlements = {}; }
            }

            let entitlement = person.entitlements && person.entitlements[currentYear] 
                ? person.entitlements[currentYear] 
                : { annual: 25, carry: 0, taken_annual: 0 }; 
            
            const balanceAnnual = (entitlement.annual + entitlement.carry) - entitlement.taken_annual;

            container.innerHTML = `
                <div id="admin-pdf-content" class="p-4 bg-white dark:bg-gray-800 dark:text-white rounded-lg">
                    <div class="flex flex-col items-center mb-6 border-b pb-4">
                        <img src="https://i.postimg.cc/595wB3cy/HOSPITAL_BINTULU.png" class="w-20 h-20 mb-2">
                        <h2 class="text-xl font-bold uppercase text-center">Rekod Cuti Pegawai & Hari Kelepasan Am</h2>
                        <h3 class="text-lg font-semibold text-primary">Unit Hemodialisis Hospital Bintulu</h3>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-6 text-sm">
                        <div>
                            <p><strong>Nama:</strong> ${person.name}</p>
                            <p><strong>No KP:</strong> ${person.ic}</p>
                            <p><strong>Jawatan:</strong> ${person.position}</p>
                            <p><strong>Gred:</strong> ${person.grade}</p>
                        </div>
                        <div class="text-right">
                             <p><strong>Tahun:</strong> ${currentYear}</p>
                             <p><strong id="admin-sum-lbl-1">Kelayakan Cuti Rehat:</strong> <span id="admin-sum-val-1">${entitlement.annual}</span></p>
                             <p><strong id="admin-sum-lbl-2">Bawa Tahun Lepas:</strong> <span id="admin-sum-val-2">${entitlement.carry}</span></p>
                             <p class="text-lg font-bold text-primary"><span id="admin-sum-lbl-3">Baki Cuti Rehat:</span> <span id="admin-sum-val-3">${balanceAnnual}</span></p>
                        </div>
                    </div>

                    <div class="flex gap-2 mb-4 no-print">
                        <button id="btn-admin-annual" onclick="switchAdminReportTab('annual')" class="px-4 py-2 rounded bg-primary text-white font-bold text-sm shadow">Rekod Cuti Tahunan Diambil</button>
                        <button id="btn-admin-ph" onclick="switchAdminReportTab('ph')" class="px-4 py-2 rounded bg-gray-200 text-gray-700 font-bold text-sm shadow">Rekod Cuti Kelepasan Am Diambil</button>
                    </div>

                    <div id="tab-admin-annual">
                        <h4 class="font-bold border-b mb-2 mt-2 flex items-center gap-2"><i class="fas fa-calendar-alt text-green-500"></i> Rekod Cuti Tahunan Diambil</h4>
                        <table class="w-full text-xs text-left mb-6 border-collapse border border-gray-300">
                            <thead>
                                <tr class="bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-white">
                                    <th class="border p-2">No.</th>
                                    <th class="border p-2">Tarikh Mohon</th>
                                    <th class="border p-2">Tarikh Cuti</th>
                                    <th class="border p-2">Jenis</th>
                                    <th class="border p-2">Hari</th>
                                    <th class="border p-2">Baki</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${leaves.length ? leaves.map((l, index) => `
                                    <tr>
                                        <td class="border p-2 text-center">${index + 1}</td>
                                        <td class="border p-2">${formatDate(l.applyDate)}</td>
                                        <td class="border p-2">${formatDate(l.startDate)} - ${formatDate(l.endDate)}</td>
                                        <td class="border p-2">${l.type}</td>
                                        <td class="border p-2 text-center">${l.days}</td>
                                        <td class="border p-2 text-center font-bold text-primary">${l.balanceAfter}</td>
                                    </tr>
                                `).join('') : `<tr><td colspan="6" class="border p-2 text-center">Tiada rekod.</td></tr>`}
                            </tbody>
                        </table>
                    </div>

                    <div id="tab-admin-ph" class="hidden">
                        <h4 class="font-bold border-b mb-2 flex items-center gap-2"><i class="fas fa-umbrella-beach text-pink-500"></i> Rekod Cuti Kelepasan Am Diambil</h4>
                        <table class="w-full text-xs text-left border-collapse border border-gray-300">
                            <thead>
                                <tr class="bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-white">
                                    <th class="border p-2">No.</th>
                                    <th class="border p-2">Nama Cuti Umum</th>
                                    <th class="border p-2">Tarikh Asal</th>
                                    <th class="border p-2">Tarikh Ganti Diambil</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${phTaken.length ? phTaken.map((p, index) => `
                                    <tr>
                                        <td class="border p-2 text-center">${index + 1}</td>
                                        <td class="border p-2">${p.holidayName}</td>
                                        <td class="border p-2">${formatDate(p.holidayDate)}</td>
                                        <td class="border p-2">${formatDate(p.takenDate)}</td>
                                    </tr>
                                `).join('') : `<tr><td colspan="4" class="border p-2 text-center">Tiada rekod.</td></tr>`}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-12 pt-8 flex justify-between text-xs print-only">
                        <div class="text-center w-1/3 border-t border-black pt-2">
                            <p>Disediakan Oleh:</p>
                            <br><br>
                            <p>(................................................)</p>
                        </div>
                        <div class="text-center w-1/3 border-t border-black pt-2">
                            <p>Disemak Oleh:</p>
                            <br><br>
                            <p>(................................................)</p>
                        </div>
                    </div>
                </div>

                <div class="mt-4 flex justify-end gap-2 p-4 bg-gray-100 dark:bg-gray-900 rounded-b-xl no-print">
                    <button onclick="generatePDF('${person.ic}', 'admin-pdf-content', currentAdminReportTab)" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded shadow flex items-center gap-2 transform hover:scale-105 transition">
                        <i class="fas fa-file-pdf"></i> Jana PDF
                    </button>
                </div>
            `;
            currentAdminReportTab = 'annual';
        }

        function updateAdminStats(tabName) {
            if (!currentAdminViewIC) return;
            const person = globalStaff.find(s => s.ic === currentAdminViewIC);
            if (!person) return;
            let label1, val1, label2, val2, label3, val3;
            if (tabName === 'annual') {
                let ent = person.entitlements;
                if(typeof ent === 'string') try { ent = JSON.parse(ent); } catch(e){ ent = {}; }
                let stats = ent[currentYear] || { annual: 25, carry: 0, taken_annual: 0 };
                let balance = (stats.annual + stats.carry) - stats.taken_annual;
                label1 = "Kelayakan Cuti Rehat:"; val1 = stats.annual;
                label2 = "Bawa Tahun Lepas:"; val2 = stats.carry;
                label3 = "Baki Cuti Rehat:"; val3 = balance;
            } else {
                const totalPH = globalHolidays.filter(h => h.date && h.date.toString().startsWith(currentYear)).length;
                const takenPH = globalPHTaken.filter(p => p.ic === currentAdminViewIC && p.year == currentYear).length;
                const balancePH = totalPH - takenPH;
                label1 = "Jum. Kelepasan Am:"; val1 = totalPH;
                label2 = "Telah Diambil:"; val2 = takenPH;
                label3 = "Baki Belum Diambil:"; val3 = balancePH;
            }
            const elL1 = document.getElementById('admin-sum-lbl-1');
            const elV1 = document.getElementById('admin-sum-val-1');
            const elL2 = document.getElementById('admin-sum-lbl-2');
            const elV2 = document.getElementById('admin-sum-val-2');
            const elL3 = document.getElementById('admin-sum-lbl-3');
            const elV3 = document.getElementById('admin-sum-val-3');
            if (elL1) elL1.innerText = label1;
            if (elV1) elV1.innerText = val1;
            if (elL2) elL2.innerText = label2;
            if (elV2) elV2.innerText = val2;
            if (elL3) elL3.innerText = label3;
            if (elV3) elV3.innerText = val3;
        }

        function switchAdminReportTab(tabName) {
            currentAdminReportTab = tabName;
            updateAdminStats(tabName);
            const btnAnnual = document.getElementById('btn-admin-annual');
            const btnPh = document.getElementById('btn-admin-ph');
            const tabAnnual = document.getElementById('tab-admin-annual');
            const tabPh = document.getElementById('tab-admin-ph');

            btnAnnual.classList.remove('bg-primary', 'text-white');
            btnPh.classList.remove('bg-primary', 'text-white');
            btnAnnual.classList.add('bg-gray-200', 'text-gray-700');
            btnPh.classList.add('bg-gray-200', 'text-gray-700');
            tabAnnual.classList.add('hidden');
            tabPh.classList.add('hidden');

            if(tabName === 'annual') {
                btnAnnual.classList.remove('bg-gray-200', 'text-gray-700');
                btnAnnual.classList.add('bg-primary', 'text-white');
                tabAnnual.classList.remove('hidden');
            } else {
                btnPh.classList.remove('bg-gray-200', 'text-gray-700');
                btnPh.classList.add('bg-primary', 'text-white');
                tabPh.classList.remove('hidden');
            }
        }

        // --- LEAVE RECORD (Updated Function for 2-step selection) ---
        function renderLeaveRecord(container) {
            const positions = [...new Set(globalStaff.map(s => s.position))];
            container.innerHTML = `
                <div class="flex flex-col lg:flex-row gap-6 h-full">
                    <div class="lg:w-1/3 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md h-fit">
                        <h3 class="text-xl font-bold text-gray-700 dark:text-white mb-4 flex items-center gap-2"><i class="fas fa-calendar-plus text-green-500"></i> Rekod Cuti Baru (${currentYear})</h3>
                        
                        <!-- Step 1: Position Select -->
                        <div class="mb-4">
                            <label class="block text-sm dark:text-gray-300">Pilih Jawatan</label>
                            <select id="leave-pos-select" onchange="filterStaffByPos(this.value)" class="w-full border p-2 rounded dark:bg-gray-700 dark:text-white mb-2 focus:ring-primary focus:border-primary">
                                <option value="">-- Sila Pilih Jawatan --</option>
                                ${positions.map(p => `<option value="${p}">${p}</option>`).join('')}
                            </select>
                        </div>

                        <!-- Step 2: Name Select (Filtered) -->
                        <div class="mb-4">
                            <label class="block text-sm dark:text-gray-300">Pilih Pegawai</label>
                            <select id="leave-staff-select" onchange="loadStaffLeaveData(this.value)" class="w-full border p-2 rounded dark:bg-gray-700 dark:text-white focus:ring-primary focus:border-primary">
                                <option value="">-- Sila Pilih Nama --</option>
                            </select>
                        </div>

                        <div id="leave-form-container" class="hidden">
                            <div class="bg-orange-50 dark:bg-orange-900/30 p-3 rounded mb-4 text-sm border-l-4 border-orange-400">
                                <p><strong>Kelayakan Cuti:</strong> <input type="number" id="entitle-annual" class="w-16 p-1 border rounded text-center dark:bg-gray-700" value="25"> hari</p>
                                <p><strong>Bawa Tahun Lepas:</strong> <input type="number" id="edit-carry" class="w-16 p-1 border rounded text-center dark:bg-gray-700 font-bold text-primary" value="0" onchange="updateCarryForward(this.value)"> hari</p>
                                <p class="text-xs text-gray-500 mt-1 italic">*Nilai bawa tahun lepas boleh diedit.</p>
                            </div>

                            <form onsubmit="submitLeave(event)" class="space-y-3">
                                <div>
                                    <label class="block text-xs uppercase text-gray-500">Jenis Cuti</label>
                                    <select id="leave-type" onchange="handleLeaveTypeChange(this.value)" class="w-full border p-2 rounded dark:bg-gray-700 dark:text-white focus:ring-primary focus:border-primary">
                                        <option value="Cuti Rehat">Cuti Rehat (Tahunan)</option>
                                        <option value="Cuti Sakit">Cuti Sakit (90 Hari)</option>
                                        <option value="Cuti Bersalin">Cuti Bersalin (90 Hari)</option>
                                        <option value="Cuti Tanpa Rekod">Cuti Tanpa Rekod (20 Hari)</option>
                                        <option value="Lain-lain">Lain-lain</option>
                                    </select>
                                </div>
                                <div id="mc-input" class="hidden">
                                    <label class="block text-xs uppercase text-gray-500">No. Sijil Sakit</label>
                                    <input type="text" id="mc-no" class="w-full border p-2 rounded dark:bg-gray-700 dark:text-white">
                                </div>
                                <div id="other-input" class="hidden">
                                    <label class="block text-xs uppercase text-gray-500">Nama Cuti Lain</label>
                                    <input type="text" id="other-name" class="w-full border p-2 rounded dark:bg-gray-700 dark:text-white">
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="block text-xs uppercase text-gray-500">Dari</label>
                                        <input type="date" id="date-start" required onchange="calcDays()" class="w-full border p-2 rounded dark:bg-gray-700 dark:text-white">
                                    </div>
                                    <div>
                                        <label class="block text-xs uppercase text-gray-500">Hingga</label>
                                        <input type="date" id="date-end" required onchange="calcDays()" class="w-full border p-2 rounded dark:bg-gray-700 dark:text-white">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs uppercase text-gray-500">Tarikh Mohon</label>
                                    <input type="date" id="date-apply" required class="w-full border p-2 rounded dark:bg-gray-700 dark:text-white">
                                </div>
                                <div class="flex justify-between items-center bg-gray-100 dark:bg-gray-700 p-2 rounded">
                                    <span class="text-sm">Jumlah Hari:</span>
                                    <span id="calc-days" class="font-bold text-lg text-primary">0</span>
                                </div>
                                <button type="submit" class="w-full bg-primary text-white py-2 rounded hover:bg-secondary transition transform hover:scale-105">Rekod Cuti</button>
                            </form>
                        </div>
                    </div>
                    <div class="lg:w-2/3 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md overflow-hidden flex flex-col">
                        <h3 class="text-xl font-bold text-gray-700 dark:text-white mb-4 flex items-center gap-2"><i class="fas fa-history text-blue-500"></i> Senarai Cuti Diambil (${currentYear})</h3>
                        <div id="leave-table-container" class="overflow-x-auto flex-1">
                            <p class="text-gray-500 text-center py-10">Pilih pegawai untuk melihat rekod.</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function filterStaffByPos(position) {
            const nameSelect = document.getElementById('leave-staff-select');
            nameSelect.innerHTML = '<option value="">-- Sila Pilih Nama --</option>';
            document.getElementById('leave-form-container').classList.add('hidden');
            document.getElementById('leave-table-container').innerHTML = '<p class="text-gray-500 text-center py-10">Pilih pegawai untuk melihat rekod.</p>';
            if (!position) return;
            const filteredStaff = globalStaff.filter(s => s.position === position);
            filteredStaff.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.ic;
                opt.innerText = s.name;
                nameSelect.appendChild(opt);
            });
        }

        function loadStaffLeaveData(ic) {
            if (!ic) {
                document.getElementById('leave-form-container').classList.add('hidden');
                document.getElementById('leave-table-container').innerHTML = '<p class="text-gray-500 text-center py-10">Sila pilih pegawai.</p>';
                return;
            }
            document.getElementById('leave-form-container').classList.remove('hidden');
            const staff = globalStaff.find(s => s.ic === ic);
            if(typeof staff.entitlements === 'string') {
                try { staff.entitlements = JSON.parse(staff.entitlements); } catch(e) { staff.entitlements = {}; }
            }
            let carryVal = 0;
            let annualVal = 25;
            if (staff.entitlements && staff.entitlements[currentYear]) {
                carryVal = staff.entitlements[currentYear].carry || 0;
                annualVal = staff.entitlements[currentYear].annual || 25;
            } else if(staff.entitlements && staff.entitlements[currentYear-1]) {
                const prev = staff.entitlements[currentYear-1];
                const pAnnual = parseInt(prev.annual) || 0;
                const pCarry = parseInt(prev.carry) || 0;
                const pTaken = parseInt(prev.taken_annual) || 0;
                let prevBalance = (pAnnual + pCarry) - pTaken;
                if(prevBalance < 0) prevBalance = 0;
                carryVal = prevBalance;
            }
            document.getElementById('edit-carry').value = carryVal;
            document.getElementById('entitle-annual').value = annualVal;
            renderLeaveTable(ic);
        }

        async function updateCarryForward(val) {
            const ic = document.getElementById('leave-staff-select').value;
            if (!ic) return;
            const staffIndex = globalStaff.findIndex(s => s.ic === ic);
            if (staffIndex > -1) {
                if (!globalStaff[staffIndex].entitlements) globalStaff[staffIndex].entitlements = {};
                if (!globalStaff[staffIndex].entitlements[currentYear]) {
                    globalStaff[staffIndex].entitlements[currentYear] = {
                        annual: parseInt(document.getElementById('entitle-annual').value),
                        carry: parseInt(val),
                        taken_annual: 0, taken_sick: 0, taken_mat: 0, taken_norec: 0
                    };
                } else {
                    globalStaff[staffIndex].entitlements[currentYear].carry = parseInt(val);
                }
                await callApi('update_entitlement', { 
                    ic: ic, 
                    entitlements: globalStaff[staffIndex].entitlements 
                });
                showToast('Cuti bawa tahun lepas dikemaskini.');
            }
        }

        function handleLeaveTypeChange(type) {
            toggleLeaveInputs(type);
            calcDays();
        }

        function toggleLeaveInputs(type) {
            document.getElementById('mc-input').classList.toggle('hidden', type !== 'Cuti Sakit');
            document.getElementById('other-input').classList.toggle('hidden', type !== 'Lain-lain');
        }

        function calcDays() {
            const startStr = document.getElementById('date-start').value;
            const endStr = document.getElementById('date-end').value;
            const leaveType = document.getElementById('leave-type').value;
            if(!startStr || !endStr) return;
            const start = new Date(startStr);
            const end = new Date(endStr);
            let count = 0;
            let cur = new Date(start);
            while (cur <= end) {
                const day = cur.getDay(); 
                if (leaveType === 'Cuti Rehat') {
                    if (day !== 0) count++;
                } else {
                    count++;
                }
                cur.setDate(cur.getDate() + 1);
            }
            document.getElementById('calc-days').innerText = count;
            return count;
        }

        async function submitLeave(e) {
            e.preventDefault();
            const ic = document.getElementById('leave-staff-select').value;
            const staff = globalStaff.find(s => s.ic === ic);
            const type = document.getElementById('leave-type').value;
            const days = parseInt(document.getElementById('calc-days').innerText);
            if (days <= 0) {
                showToast('Jumlah hari mestilah lebih dari 0', 'error');
                return;
            }
            if (!staff.entitlements) staff.entitlements = {};
            if (!staff.entitlements[currentYear]) {
                staff.entitlements[currentYear] = {
                    annual: parseInt(document.getElementById('entitle-annual').value),
                    carry: parseInt(document.getElementById('edit-carry').value),
                    taken_annual: 0, taken_sick: 0, taken_mat: 0, taken_norec: 0
                };
            }
            let stats = staff.entitlements[currentYear];
            let balance = 0;
            if (type === 'Cuti Rehat') {
                stats.taken_annual += days;
                balance = (stats.annual + stats.carry) - stats.taken_annual;
            } else if (type === 'Cuti Sakit') {
                stats.taken_sick += days;
                balance = 90 - stats.taken_sick;
            } else if (type === 'Cuti Bersalin') {
                stats.taken_mat += days;
                balance = 90 - stats.taken_mat;
            } else if (type === 'Cuti Tanpa Rekod') {
                stats.taken_norec += days;
                balance = 20 - stats.taken_norec;
            }
            const newRecord = {
                id: Date.now().toString(),
                ic: ic, name: staff.name, year: parseInt(currentYear), type: type,
                details: type === 'Cuti Sakit' ? document.getElementById('mc-no').value : (type === 'Lain-lain' ? document.getElementById('other-name').value : ''),
                startDate: document.getElementById('date-start').value,
                endDate: document.getElementById('date-end').value,
                applyDate: document.getElementById('date-apply').value,
                days: days, balanceAfter: balance, admin: currentUser.name
            };
            const res = await callApi('add_leave', {
                leave: newRecord,
                staffEntitlements: staff.entitlements
            });
            if (res) {
                showToast('Cuti berjaya direkod!', 'success');
                e.target.reset();
                document.getElementById('calc-days').innerText = '0';
                initSystem().then(() => loadStaffLeaveData(ic));
            }
        }

        function renderLeaveTable(ic) {
            const leaves = globalLeaves.filter(l => l.ic === ic && l.year == currentYear)
                .sort((a,b) => new Date(b.startDate) - new Date(a.startDate));
            let html = `
                <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-100 dark:bg-gray-700 dark:text-gray-200">
                        <tr>
                            <th class="px-4 py-3">No.</th>
                            <th class="px-4 py-3">Tarikh Mohon</th>
                            <th class="px-4 py-3">Tempoh Cuti</th>
                            <th class="px-4 py-3">Jenis</th>
                            <th class="px-4 py-3">Hari</th>
                            <th class="px-4 py-3">Baki</th>
                            <th class="px-4 py-3">Admin</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            if (leaves.length === 0) {
                html += `<tr><td colspan="7" class="px-4 py-4 text-center">Tiada rekod cuti tahun ini.</td></tr>`;
            } else {
                leaves.forEach((l, index) => {
                    html += `
                        <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 transition-colors">
                            <td class="px-4 py-2">${index + 1}</td>
                            <td class="px-4 py-2">${formatDate(l.applyDate)}</td>
                            <td class="px-4 py-2">${formatDate(l.startDate)} - ${formatDate(l.endDate)}</td>
                            <td class="px-4 py-2 font-medium text-gray-900 dark:text-white">
                                ${l.type} <br><span class="text-xs text-gray-500">${l.details}</span>
                            </td>
                            <td class="px-4 py-2">${l.days}</td>
                            <td class="px-4 py-2 font-bold text-primary">${l.balanceAfter}</td>
                            <td class="px-4 py-2 text-xs">${l.admin}</td>
                        </tr>
                    `;
                });
            }
            html += `</tbody></table>`;
            document.getElementById('leave-table-container').innerHTML = html;
        }

        // --- PUBLIC HOLIDAY FUNCTIONS ---
        function renderPhConfig(container) {
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                        <h3 class="text-lg font-bold mb-4 dark:text-white flex items-center gap-2"><i class="fas fa-plus-circle text-green-500"></i> Tambah Hari Kelepasan Am</h3>
                        <form onsubmit="addHoliday(event)" class="space-y-4">
                            <div>
                                <label class="block text-sm">Nama Hari Kelepasan</label>
                                <input type="text" name="name" required class="w-full border rounded p-2 dark:bg-gray-700 dark:text-white focus:ring-primary focus:border-primary">
                            </div>
                            <div>
                                <label class="block text-sm">Tarikh</label>
                                <input type="date" name="date" required class="w-full border rounded p-2 dark:bg-gray-700 dark:text-white focus:ring-primary focus:border-primary">
                            </div>
                            <button class="w-full bg-primary text-white py-2 rounded hover:bg-secondary transition transform hover:scale-105">Tambah</button>
                        </form>
                    </div>
                    <div class="md:col-span-2 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                        <h3 class="text-lg font-bold mb-4 dark:text-white flex items-center gap-2"><i class="fas fa-list text-blue-500"></i> Senarai Hari Kelepasan Am</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left dark:text-gray-300">
                                <thead class="bg-gray-100 dark:bg-gray-700 uppercase text-xs">
                                    <tr>
                                        <th class="px-4 py-2 w-16">No.</th>
                                        <th class="px-4 py-2">Nama</th>
                                        <th class="px-4 py-2">Tarikh</th>
                                        <th class="px-4 py-2 text-right">Tindakan</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${globalHolidays.sort((a,b) => new Date(a.date) - new Date(b.date)).map((h, index) => `
                                        <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors">
                                            <td class="px-4 py-2">${index + 1}</td>
                                            <td class="px-4 py-2">${h.name}</td>
                                            <td class="px-4 py-2">${formatDate(h.date)}</td>
                                            <td class="px-4 py-2 text-right">
                                                <button onclick="confirmDeleteHoliday('${h.id}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                    ${globalHolidays.length === 0 ? '<tr><td colspan="4" class="text-center p-4">Tiada data.</td></tr>' : ''}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        async function addHoliday(e) {
            e.preventDefault();
            const res = await callApi('add_holiday', {
                id: Date.now().toString(),
                name: e.target.name.value,
                date: e.target.date.value
            });
            if (res) {
                showToast('Hari kelepasan ditambah.');
                initSystem().then(() => showPage('ph-config'));
            }
        }

        function confirmDeleteHoliday(id) {
            showConfirmModal('Padam Cuti?', 'Adakah anda pasti mahu memadam cuti am ini?', () => {
                deleteHoliday(id);
            });
        }

        async function deleteHoliday(id) {
            const res = await callApi('delete_holiday', { id: id });
            if (res) {
                showToast('Hari kelepasan dipadam.');
                initSystem().then(() => showPage('ph-config'));
            }
        }

        // --- PH RECORD CLAIM ---
        function renderPhRecord(container) {
             const positions = [...new Set(globalStaff.map(s => s.position))];
             container.innerHTML = `
                <div class="flex flex-col lg:flex-row gap-6">
                    <div class="lg:w-1/3 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                         <h3 class="text-xl font-bold dark:text-white mb-4 flex items-center gap-2"><i class="fas fa-calendar-check text-purple-500"></i> Tuntut Cuti Kelepasan Am</h3>
                         
                         <div class="mb-4">
                            <label class="block text-sm dark:text-gray-300">Pilih Jawatan</label>
                            <select id="ph-pos-select" onchange="filterPhStaffByPos(this.value)" class="w-full border p-2 rounded dark:bg-gray-700 dark:text-white mb-2 focus:ring-primary focus:border-primary">
                                <option value="">-- Sila Pilih Jawatan --</option>
                                ${positions.map(p => `<option value="${p}">${p}</option>`).join('')}
                            </select>
                        </div>
                         <div class="mb-4">
                            <label class="block text-sm dark:text-gray-300">Pilih Pegawai</label>
                            <select id="ph-staff-select" onchange="renderPhSelection(this.value)" class="w-full border p-2 rounded dark:bg-gray-700 dark:text-white focus:ring-primary focus:border-primary">
                                <option value="">-- Sila Pilih Nama --</option>
                            </select>
                        </div>
                        <div id="ph-selection-area" class="space-y-3"></div>
                    </div>
                    <div class="lg:w-2/3 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                        <h3 class="text-xl font-bold dark:text-white mb-4 flex items-center gap-2"><i class="fas fa-clipboard-list text-teal-500"></i> Rekod Tuntutan</h3>
                         <div id="ph-table-area"></div>
                    </div>
                </div>
             `;
        }

        function filterPhStaffByPos(position) {
            const nameSelect = document.getElementById('ph-staff-select');
            nameSelect.innerHTML = '<option value="">-- Sila Pilih Nama --</option>';
            document.getElementById('ph-selection-area').innerHTML = '';
            document.getElementById('ph-table-area').innerHTML = '';
            if (!position) return;
            const filteredStaff = globalStaff.filter(s => s.position === position);
            filteredStaff.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.ic;
                opt.innerText = s.name;
                nameSelect.appendChild(opt);
            });
        }

        function renderPhSelection(ic) {
            if(!ic) {
                document.getElementById('ph-selection-area').innerHTML = '';
                document.getElementById('ph-table-area').innerHTML = '';
                return;
            }
            const taken = globalPHTaken.filter(t => t.ic === ic);
            const available = globalHolidays.filter(h => !taken.some(t => t.holidayDate === h.date));
            let html = `
                <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded border dark:border-gray-600">
                    <p class="text-sm font-bold dark:text-white mb-2">Pilih Hari Untuk Dituntut:</p>
                    <div class="mt-2 max-h-80 overflow-y-auto">
            `;
            if(available.length === 0) {
                html += `<p class="text-sm text-gray-500">Tiada hari kelepasan am yang boleh dituntut atau semua telah diambil.</p>`;
            } else {
                available.forEach((h, index) => {
                    const uniqueId = `rep-date-${index}`;
                    html += `
                        <div class="flex flex-col p-2 border-b last:border-0 dark:border-gray-600 mb-2">
                            <span class="text-xs dark:text-gray-200 font-bold">${formatDate(h.date)} - ${h.name}</span>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-xs text-gray-500">Tarikh Ganti:</span>
                                <input type="date" id="${uniqueId}" class="border rounded p-1 text-xs dark:bg-gray-600 dark:text-white">
                                <button onclick="claimPh('${ic}', '${h.date}', '${h.name}', '${uniqueId}')" class="bg-green-500 text-white px-2 py-1 text-xs rounded hover:bg-green-600 transform hover:scale-105 transition">Ambil</button>
                            </div>
                        </div>
                    `;
                });
            }
            html += `</div></div>`;
            document.getElementById('ph-selection-area').innerHTML = html;
            renderPhTable(ic);
        }

        async function claimPh(ic, hDate, hName, inputId) {
            const repDateInput = document.getElementById(inputId);
            const repDate = repDateInput.value;
            if (!repDate) {
                alert("Sila pilih 'Tarikh Ganti Diambil' terlebih dahulu.");
                return;
            }
            const res = await callApi('add_ph_claim', {
                id: Date.now().toString(),
                ic: ic,
                holidayDate: hDate,
                holidayName: hName,
                takenDate: repDate,
                year: currentYear
            });
            if (res) {
                showToast('Tuntutan cuti direkod.');
                initSystem().then(() => renderPhSelection(ic));
            }
        }

        function unclaimPh(id, ic) {
            showConfirmModal('Batalkan Tuntutan?', 'Adakah anda pasti mahu membatalkan tuntutan ini? Hari ini akan kembali ke senarai boleh dituntut.', async () => {
                const res = await callApi('delete_ph_claim', { id: id });
                if (res) {
                    showToast('Tuntutan dibatalkan.');
                    initSystem().then(() => renderPhSelection(ic));
                }
            });
        }

        function renderPhTable(ic) {
             const taken = globalPHTaken.filter(t => t.ic === ic);
             let html = `
                <table class="w-full text-sm text-left dark:text-gray-300">
                    <thead class="bg-gray-100 dark:bg-gray-700 uppercase text-xs">
                        <tr>
                            <th class="px-4 py-2 w-16">No.</th>
                            <th class="px-4 py-2">Cuti Umum</th>
                            <th class="px-4 py-2">Tarikh Asal</th>
                            <th class="px-4 py-2">Tarikh Ganti Diambil</th>
                            <th class="px-4 py-2 text-center">Tindakan</th>
                        </tr>
                    </thead>
                    <tbody>
             `;
             taken.forEach((t, index) => {
                 html += `
                    <tr class="border-b dark:border-gray-700 hover:bg-gray-50 transition-colors">
                        <td class="px-4 py-2">${index + 1}</td>
                        <td class="px-4 py-2">${t.holidayName}</td>
                        <td class="px-4 py-2">${formatDate(t.holidayDate)}</td>
                        <td class="px-4 py-2 font-bold text-primary">${formatDate(t.takenDate)}</td>
                        <td class="px-4 py-2 text-center">
                            <button onclick="unclaimPh('${t.id}', '${ic}')" class="text-red-500 hover:text-red-700" title="Kembalikan">
                                <i class="fas fa-undo"></i>
                            </button>
                        </td>
                    </tr>
                 `;
             });
             html += `</tbody></table>`;
             document.getElementById('ph-table-area').innerHTML = html;
        }

        // --- ADMIN REGISTRATION ---
        function renderAdminReg(container) {
            container.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-lg max-w-lg mx-auto mb-8">
                    <h2 class="text-2xl font-bold text-primary mb-6 flex items-center gap-2"><i class="fas fa-user-shield text-gray-500"></i> Daftar Admin Baru</h2>
                    <form onsubmit="registerAdmin(event)" class="space-y-4">
                        <div>
                            <label class="block text-sm dark:text-white">Nama</label>
                            <input type="text" id="reg-admin-name" required class="w-full border rounded p-2 dark:bg-gray-700 dark:text-white focus:ring-primary focus:border-primary">
                        </div>
                        <div>
                            <label class="block text-sm dark:text-white">Email</label>
                            <input type="email" id="reg-admin-email" required class="w-full border rounded p-2 dark:bg-gray-700 dark:text-white focus:ring-primary focus:border-primary">
                        </div>
                        <div>
                            <label class="block text-sm dark:text-white">Password</label>
                            <input type="password" id="reg-admin-pass" required class="w-full border rounded p-2 dark:bg-gray-700 dark:text-white focus:ring-primary focus:border-primary">
                        </div>
                        <button class="w-full bg-primary text-white py-2 rounded font-bold hover:bg-secondary transition transform hover:scale-105">Daftar</button>
                    </form>
                </div>

                <div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-lg max-w-3xl mx-auto">
                    <h3 class="text-xl font-bold text-gray-700 dark:text-white mb-4">Senarai Admin Berdaftar</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left dark:text-gray-300">
                            <thead class="bg-gray-100 dark:bg-gray-700 uppercase text-xs font-bold">
                                <tr>
                                    <th class="px-4 py-3">Nama</th>
                                    <th class="px-4 py-3">Email</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${globalUsers.map(a => `
                                    <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors">
                                        <td class="px-4 py-2 font-medium">${a.name}</td>
                                        <td class="px-4 py-2">${a.email}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        async function registerAdmin(e) {
            e.preventDefault();
            const res = await callApi('register_admin', {
                id: Date.now().toString(),
                name: document.getElementById('reg-admin-name').value,
                email: document.getElementById('reg-admin-email').value,
                pass: document.getElementById('reg-admin-pass').value
            });
            
            if (res) {
                showToast('Admin baru didaftarkan!');
                initSystem().then(() => showPage('admin-reg'));
            }
        }

        // --- PUBLIC REPORT & PDF ---
        window.showPublicTab = function(tabName) {
            currentPublicTab = tabName;
            document.getElementById('btn-view-annual').classList.remove('bg-primary', 'text-white');
            document.getElementById('btn-view-ph').classList.remove('bg-primary', 'text-white');
            document.getElementById('btn-view-annual').classList.add('bg-gray-200', 'text-gray-700');
            document.getElementById('btn-view-ph').classList.add('bg-gray-200', 'text-gray-700');

            document.getElementById('tab-annual').classList.add('hidden');
            document.getElementById('tab-ph').classList.add('hidden');

            if(tabName === 'annual') {
                document.getElementById('btn-view-annual').classList.remove('bg-gray-200', 'text-gray-700');
                document.getElementById('btn-view-annual').classList.add('bg-primary', 'text-white');
                document.getElementById('tab-annual').classList.remove('hidden');
            } else {
                document.getElementById('btn-view-ph').classList.remove('bg-gray-200', 'text-gray-700');
                document.getElementById('btn-view-ph').classList.add('bg-primary', 'text-white');
                document.getElementById('tab-ph').classList.remove('hidden');
            }
        }

        function renderPublicReport(person) {
            let entitlement = {};
            if(typeof person.entitlements === 'string') {
                try { entitlement = JSON.parse(person.entitlements); } catch(e){}
            } else {
                entitlement = person.entitlements || {};
            }
            
            let yrEntitlement = entitlement[currentYear] || { annual: 25, carry: 0, taken_annual: 0 };

            const leaves = globalLeaves.filter(l => l.ic === person.ic && l.year == currentYear)
                .sort((a,b) => new Date(a.startDate) - new Date(b.startDate));
            
            const phTaken = globalPHTaken.filter(p => p.ic === person.ic && p.year == currentYear);
            
            const totalAnnualEntitlement = yrEntitlement.annual + yrEntitlement.carry;
            const balanceAnnual = totalAnnualEntitlement - yrEntitlement.taken_annual;

            const content = document.getElementById('public-result-content');
            content.innerHTML = `
                <div id="pdf-content" class="p-4 bg-white dark:bg-gray-800 dark:text-white">
                    <div class="flex flex-col items-center mb-6 border-b pb-4">
                        <img src="https://i.postimg.cc/595wB3cy/HOSPITAL_BINTULU.png" class="w-20 h-20 mb-2">
                        <h2 class="text-xl font-bold uppercase text-center">Rekod Cuti Pegawai & Hari Kelepasan Am</h2>
                        <h3 class="text-lg font-semibold text-primary">Unit Hemodialisis Hospital Bintulu</h3>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-6 text-sm">
                        <div>
                            <p><strong>Nama:</strong> ${person.name}</p>
                            <p><strong>No KP:</strong> ${person.ic}</p>
                            <p><strong>Jawatan:</strong> ${person.position}</p>
                            <p><strong>Gred:</strong> ${person.grade}</p>
                        </div>
                        <div class="text-right">
                             <p><strong>Tahun:</strong> ${currentYear}</p>
                             <p><strong>Kelayakan Cuti Rehat:</strong> ${yrEntitlement.annual}</p>
                             <p><strong>Bawa Tahun Lepas:</strong> ${yrEntitlement.carry}</p>
                             <p class="text-lg font-bold text-primary">Baki Cuti Rehat: ${balanceAnnual}</p>
                        </div>
                    </div>

                    <div class="flex gap-2 mb-4 no-print">
                        <button id="btn-view-annual" onclick="showPublicTab('annual')" class="px-4 py-2 rounded bg-primary text-white font-bold text-sm shadow transform hover:scale-105 transition">Rekod Cuti Tahunan Diambil</button>
                        <button id="btn-view-ph" onclick="showPublicTab('ph')" class="px-4 py-2 rounded bg-gray-200 text-gray-700 font-bold text-sm shadow transform hover:scale-105 transition">Rekod Cuti Kelepasan Am Diambil</button>
                    </div>

                    <div id="tab-annual">
                        <h4 class="font-bold border-b mb-2 mt-2 flex items-center gap-2"><i class="fas fa-calendar text-orange-500"></i> Rekod Cuti Tahunan Diambil</h4>
                        <table class="w-full text-xs text-left mb-6 border-collapse border border-gray-300">
                            <thead>
                                <tr class="bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-white">
                                    <th class="border p-2">No.</th>
                                    <th class="border p-2">Tarikh Mohon</th>
                                    <th class="border p-2">Tarikh Cuti</th>
                                    <th class="border p-2">Jenis</th>
                                    <th class="border p-2">Hari</th>
                                    <th class="border p-2">Baki</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${leaves.length ? leaves.map((l, index) => `
                                    <tr>
                                        <td class="border p-2 text-center">${index + 1}</td>
                                        <td class="border p-2">${formatDate(l.applyDate)}</td>
                                        <td class="border p-2">${formatDate(l.startDate)} - ${formatDate(l.endDate)}</td>
                                        <td class="border p-2">${l.type}</td>
                                        <td class="border p-2 text-center">${l.days}</td>
                                        <td class="border p-2 text-center font-bold text-primary">${l.balanceAfter}</td>
                                    </tr>
                                `).join('') : `<tr><td colspan="6" class="border p-2 text-center">Tiada rekod.</td></tr>`}
                            </tbody>
                        </table>
                    </div>

                    <div id="tab-ph" class="hidden">
                        <h4 class="font-bold border-b mb-2 flex items-center gap-2"><i class="fas fa-umbrella text-blue-500"></i> Rekod Cuti Kelepasan Am Diambil</h4>
                        <table class="w-full text-xs text-left border-collapse border border-gray-300">
                            <thead>
                                <tr class="bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-white">
                                    <th class="border p-2">No.</th>
                                    <th class="border p-2">Nama Cuti Umum</th>
                                    <th class="border p-2">Tarikh Asal</th>
                                    <th class="border p-2">Tarikh Ganti Diambil</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${phTaken.length ? phTaken.map((p, index) => `
                                    <tr>
                                        <td class="border p-2 text-center">${index + 1}</td>
                                        <td class="border p-2">${p.holidayName}</td>
                                        <td class="border p-2">${formatDate(p.holidayDate)}</td>
                                        <td class="border p-2">${formatDate(p.takenDate)}</td>
                                    </tr>
                                `).join('') : `<tr><td colspan="4" class="border p-2 text-center">Tiada rekod.</td></tr>`}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-12 pt-8 flex justify-between text-xs print-only">
                        <div class="text-center w-1/3 border-t border-black pt-2">
                            <p>Disediakan Oleh:</p>
                            <br><br>
                            <p>(................................................)</p>
                        </div>
                        <div class="text-center w-1/3 border-t border-black pt-2">
                            <p>Disemak Oleh:</p>
                            <br><br>
                            <p>(................................................)</p>
                        </div>
                    </div>
                </div>

                <div class="mt-4 flex justify-end gap-2 p-4 bg-gray-100 dark:bg-gray-900 rounded-b-xl">
                    <button onclick="generatePDF('${person.ic}', 'pdf-content', currentPublicTab)" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded shadow flex items-center gap-2 transform hover:scale-105 transition">
                        <i class="fas fa-file-pdf"></i> Jana PDF
                    </button>
                    <button onclick="closePublicView()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded shadow transform hover:scale-105 transition">
                        Tutup
                    </button>
                </div>
            `;
            currentPublicTab = 'annual';
        }

        async function generatePDF(ic, containerId, activeTab) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const pageWidth = doc.internal.pageSize.width;
            
            try {
                const img = document.getElementById('logo-hidden');
                const canvas = document.createElement("canvas");
                canvas.width = img.naturalWidth;
                canvas.height = img.naturalHeight;
                const ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0);
                const dataURL = canvas.toDataURL("image/png");
                
                const imgWidth = 25; 
                const imgHeight = (img.naturalHeight / img.naturalWidth) * imgWidth;
                const xPos = (pageWidth - imgWidth) / 2;
                doc.addImage(dataURL, 'PNG', xPos, 10, imgWidth, imgHeight);
            } catch(e) {
                console.error("Image error", e);
                doc.setFontSize(10);
                doc.text("[LOGO HOSPITAL BINTULU]", pageWidth/2, 20, {align:'center'});
            }

            doc.setFontSize(14);
            doc.setTextColor(255, 100, 0);
            doc.text("UNIT HEMODIALISIS - HOSPITAL BINTULU", pageWidth/2, 40, {align: 'center'});
            
            doc.setTextColor(0,0,0);
            doc.setFontSize(12);
            doc.text("REKOD CUTI PEGAWAI", pageWidth/2, 48, {align: 'center'});
            
            doc.setFontSize(10);
            const dateStr = new Date().toLocaleDateString('ms-MY');
            doc.text(`Tarikh Cetakan: ${dateStr}`, pageWidth/2, 55, {align: 'center'});

            const person = globalStaff.find(s => s.ic === ic);
            let statLabel1, statVal1, statLabel2, statVal2, statLabel3, statVal3;
            
            if(activeTab === 'annual') {
                let ent = person.entitlements;
                if(typeof ent === 'string') try { ent = JSON.parse(ent); } catch(e){ ent = {}; }
                let stats = ent[currentYear] || { annual: 25, carry: 0, taken_annual: 0 };
                let balance = (stats.annual + stats.carry) - stats.taken_annual;
                
                statLabel1 = "Kelayakan Cuti:"; statVal1 = `${stats.annual} Hari`;
                statLabel2 = "Bawa Thn Lepas:"; statVal2 = `${stats.carry} Hari`;
                statLabel3 = "Baki Cuti Rehat:"; statVal3 = `${balance} Hari`;
            } else {
                const totalPH = globalHolidays.filter(h => h.date && h.date.toString().startsWith(currentYear)).length;
                const takenPH = globalPHTaken.filter(p => p.ic === ic && p.year == currentYear).length;
                const balancePH = totalPH - takenPH;
                
                statLabel1 = "Jum. Kelepasan Am:"; statVal1 = `${totalPH} Hari`;
                statLabel2 = "Telah Diambil:"; statVal2 = `${takenPH} Hari`; 
                statLabel3 = "Baki Belum Diambil:"; statVal3 = `${balancePH} Hari`;
            }

            doc.setFontSize(10);
            doc.setFont("helvetica", "bold");
            
            doc.text(`Nama:`, 14, 65);
            doc.setFont("helvetica", "normal");
            doc.text(person.name.toUpperCase(), 35, 65);

            doc.setFont("helvetica", "bold");
            doc.text(`No KP:`, 14, 70);
            doc.setFont("helvetica", "normal");
            doc.text(person.ic, 35, 70);

            doc.setFont("helvetica", "bold");
            doc.text(`Jawatan:`, 14, 75);
            doc.setFont("helvetica", "normal");
            doc.text(person.position, 35, 75);

            doc.setFont("helvetica", "bold");
            doc.text(`Gred:`, 14, 80);
            doc.setFont("helvetica", "normal");
            doc.text(person.grade, 35, 80);

            const rightColX = 110;
            const rightValX = 160;

            doc.setFont("helvetica", "bold");
            doc.text(`Tahun:`, rightColX, 65);
            doc.setFont("helvetica", "normal");
            doc.text(currentYear.toString(), rightValX, 65);

            doc.setFont("helvetica", "bold");
            doc.text(statLabel1, rightColX, 70);
            doc.setFont("helvetica", "normal");
            doc.text(statVal1, rightValX, 70);

            doc.setFont("helvetica", "bold");
            doc.text(statLabel2, rightColX, 75);
            doc.setFont("helvetica", "normal");
            doc.text(statVal2, rightValX, 75);

            doc.setFont("helvetica", "bold");
            doc.setTextColor(255, 100, 0); 
            doc.text(statLabel3, rightColX, 80);
            doc.text(statVal3, rightValX, 80);
            doc.setTextColor(0,0,0);

            const container = document.getElementById(containerId);
            const tempContainer = container.cloneNode(true);
            const tables = container.querySelectorAll('table');
            let finalY = 90;

            doc.setDrawColor(200);
            doc.line(14, 85, 196, 85); 

            if(activeTab === 'annual') {
                doc.setFontSize(11);
                doc.setFont("helvetica", "bold");
                doc.text("Rekod Cuti Tahunan Diambil", 14, finalY);
                doc.autoTable({
                    html: tables[0], 
                    startY: finalY + 5,
                    theme: 'grid',
                    headStyles: { fillColor: [249, 115, 22] }, 
                    styles: { fontSize: 8 }
                });
                finalY = doc.lastAutoTable.finalY;
            } else {
                doc.setFontSize(11);
                doc.setFont("helvetica", "bold");
                doc.text("Rekod Cuti Kelepasan Am Diambil", 14, finalY);
                const phTable = tables[1];
                const phClone = phTable.cloneNode(true);
                const headers = phClone.querySelectorAll('thead th');
                if(headers.length > 0 && headers[headers.length-1].innerText.includes('Tindakan')) {
                    headers[headers.length-1].remove();
                    const rows = phClone.querySelectorAll('tbody tr');
                    rows.forEach(row => {
                        if(row.lastElementChild) row.lastElementChild.remove();
                    });
                }
                doc.autoTable({
                    html: phClone, 
                    startY: finalY + 5,
                    theme: 'grid',
                    headStyles: { fillColor: [50, 50, 50] }, 
                    styles: { fontSize: 8 }
                });
                finalY = doc.lastAutoTable.finalY;
            }
                
            const pageHeight = doc.internal.pageSize.height;
            let sigY = finalY + 40;
            if (sigY > pageHeight - 40) {
                doc.addPage();
                sigY = 40;
            }

            doc.setDrawColor(0);
            doc.line(20, sigY, 80, sigY); 
            doc.line(130, sigY, 190, sigY); 
            
            doc.setFontSize(9);
            doc.setFont("helvetica", "normal");
            doc.text("Disediakan Oleh:", 20, sigY - 25);
            doc.text("Disemak Oleh:", 130, sigY - 25);

            doc.save(`Rekod_Cuti_${person.name.replace(/\s+/g, '_')}_${activeTab}.pdf`);
        }

        // --- UTILS ---
        function formatDate(dateString) {
            if(!dateString) return "-";
            const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
            return new Date(dateString).toLocaleDateString('ms-MY', options);
        }

        function showToast(msg, type='info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const color = type === 'success' ? 'bg-green-500' : (type === 'error' ? 'bg-red-500' : 'bg-blue-500');
            toast.className = `${color} text-white px-6 py-3 rounded shadow-lg transform transition-all duration-300 translate-x-full opacity-0 flex items-center`;
            toast.innerHTML = `<span class="font-bold">${msg}</span>`;
            container.appendChild(toast);
            requestAnimationFrame(() => {
                toast.classList.remove('translate-x-full', 'opacity-0');
            });
            setTimeout(() => {
                toast.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
        }
    </script>
</body>
</html>