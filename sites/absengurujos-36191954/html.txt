<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistem Manajemen Sekolah</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', 'Segoe UI', sans-serif;
      padding-bottom: 40px;
    }
    
    .gradient-bg {
      background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
    }
    
    .card-shadow {
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    .input-focus:focus {
      transform: translateY(-2px);
      transition: all 0.2s ease;
    }
    
    .app-footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(30, 58, 138, 0.95);
      color: white;
      padding: 10px 0;
      text-align: center;
      font-size: 13px;
      z-index: 100;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    
    canvas {
      cursor: crosshair;
      background-color: white;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full gradient-bg"><!-- Footer Credit -->
  <div class="app-footer">
   By. Mujiono, SDN 20 TBT@2025
  </div>
  <div id="app" class="h-full w-full overflow-auto"><!-- Login Form -->
   <div id="loginForm" class="min-h-full flex items-center justify-center p-6">
    <div class="bg-white rounded-3xl card-shadow p-8 w-full max-w-md">
     <div class="text-center mb-8">
      <div class="w-20 h-20 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-full flex items-center justify-center mx-auto mb-4"><span class="text-4xl">??</span>
      </div>
      <h1 class="text-3xl font-bold text-gray-800 mb-2">ABSEN GURU.JOS</h1>
      <p class="text-gray-600">Kemdikdasmen</p>
     </div>
     <form onsubmit="handleLogin(event)" class="space-y-5">
      <div><label for="loginUsername" class="block text-sm font-semibold text-gray-700 mb-2">Username</label> <input type="text" id="loginUsername" required class="input-focus w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none transition-all" placeholder="Username">
      </div>
      <div><label for="loginPassword" class="block text-sm font-semibold text-gray-700 mb-2">Password</label> <input type="password" id="loginPassword" required class="input-focus w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none transition-all" placeholder="••••••••">
      </div>
      <div class="flex items-center mb-4"><input type="checkbox" id="rememberMe" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"> <label for="rememberMe" class="ml-2 text-sm text-gray-600">Ingat saya di perangkat ini</label>
      </div><button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3 rounded-xl font-semibold hover:from-blue-700 hover:to-indigo-700 transform hover:scale-105 transition-all shadow-lg"> Masuk </button>
     </form>
     <div id="savedAccountsSection" class="mt-6 space-y-2" style="display: none;">
      <p class="text-sm font-semibold text-gray-700 text-center">Akun Tersimpan di Perangkat Ini</p>
      <div id="savedAccountsList" class="space-y-2"></div>
      <hr class="my-4">
     </div>
     <div class="mt-6 space-y-3"><button onclick="showRegisterSekolah()" class="w-full text-blue-600 hover:text-blue-800 font-semibold py-2 border-2 border-blue-600 rounded-xl hover:bg-blue-50 transition-all"> Registrasi Sekolah </button> <button onclick="showRegisterGuru()" class="w-full text-green-600 hover:text-green-800 font-semibold py-2 border-2 border-green-600 rounded-xl hover:bg-green-50 transition-all"> Registrasi Guru </button>
     </div>
    </div>
   </div><!-- Register Sekolah Form -->
   <div id="registerSekolahForm" class="hidden min-h-full flex items-center justify-center p-6">
    <div class="bg-white rounded-3xl card-shadow p-8 w-full max-w-lg">
     <div class="text-center mb-6">
      <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center mx-auto mb-3"><span class="text-3xl">??</span>
      </div>
      <h1 class="text-2xl font-bold text-gray-800 mb-2">Registrasi Sekolah</h1>
      <div class="bg-yellow-50 border-l-4 border-yellow-500 p-3 mt-3 text-left">
       <p class="text-sm text-yellow-800 font-semibold">?? Perhatian:</p>
       <p class="text-xs text-yellow-700 mt-1">Pendaftaran hanya dapat dilakukan <strong>1 kali</strong>. Pastikan data yang diisi sudah benar.</p>
      </div>
     </div>
     <form onsubmit="handleRegisterSekolah(event)" class="space-y-4">
      <div><label for="regSekolahNPSN" class="block text-sm font-semibold text-gray-700 mb-2">NPSN <span class="text-red-500">*</span></label> <input type="text" id="regSekolahNPSN" required class="input-focus w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none transition-all" placeholder="Nomor NPSN">
      </div>
      <div><label for="regSekolahNama" class="block text-sm font-semibold text-gray-700 mb-2">Nama Sekolah <span class="text-red-500">*</span></label> <input type="text" id="regSekolahNama" required class="input-focus w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none transition-all" placeholder="Nama Sekolah">
      </div>
      <div><label for="regSekolahUsername" class="block text-sm font-semibold text-gray-700 mb-2">Username <span class="text-red-500">*</span></label> <input type="text" id="regSekolahUsername" required class="input-focus w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none transition-all" placeholder="Username">
      </div>
      <div><label for="regSekolahPassword" class="block text-sm font-semibold text-gray-700 mb-2">Password <span class="text-red-500">*</span></label> <input type="password" id="regSekolahPassword" required minlength="4" class="input-focus w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none transition-all" placeholder="Password">
      </div><button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white py-3 rounded-xl font-semibold hover:from-blue-700 hover:to-blue-800 transition-all shadow-lg"> Daftar Sekolah </button>
     </form>
     <div class="mt-4 text-center"><button onclick="showLogin()" class="text-blue-600 hover:text-blue-800 font-semibold"> ? Kembali ke Login </button>
     </div>
    </div>
   </div><!-- Register Guru Form -->
   <div id="registerGuruForm" class="hidden min-h-full flex items-center justify-center p-6">
    <div class="bg-white rounded-3xl card-shadow p-8 w-full max-w-2xl">
     <div class="text-center mb-6">
      <div class="w-16 h-16 bg-gradient-to-br from-green-500 to-green-600 rounded-full flex items-center justify-center mx-auto mb-3"><span class="text-3xl">?????</span>
      </div>
      <h1 class="text-2xl font-bold text-gray-800 mb-2">Registrasi Guru</h1>
      <div class="bg-yellow-50 border-l-4 border-yellow-500 p-3 mt-3 text-left">
       <p class="text-sm text-yellow-800 font-semibold">?? Perhatian:</p>
       <p class="text-xs text-yellow-700 mt-1">Pendaftaran hanya dapat dilakukan <strong>1 kali</strong>. Pastikan nama sudah benar.</p>
       <p class="text-xs text-yellow-700 mt-1">?? <strong>Username &amp; Password</strong> otomatis dari nama (huruf kecil, tanpa spasi, tanpa gelar)</p>
       <p class="text-xs text-yellow-700">Contoh: Dr. Roro Jonggrang, M.Pd. ? username: <strong>rorojonggrang</strong>, password: <strong>rorojonggrang</strong></p>
      </div>
     </div>
     <form onsubmit="handleRegisterGuru(event)" class="space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
       <div><label for="regGuruNPSN" class="block text-sm font-semibold text-gray-700 mb-2">NPSN <span class="text-red-500">*</span></label> <input type="text" id="regGuruNPSN" required oninput="autoFillNamaSekolah()" class="input-focus w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-green-500 focus:outline-none transition-all" placeholder="NPSN Sekolah">
       </div>
       <div><label for="regGuruNamaSekolah" class="block text-sm font-semibold text-gray-700 mb-2">Nama Sekolah <span class="text-red-500">*</span></label> <input type="text" id="regGuruNamaSekolah" required readonly class="input-focus w-full px-4 py-3 border-2 border-gray-200 rounded-xl bg-gray-100 cursor-not-allowed transition-all" placeholder="Otomatis terisi">
       </div>
      </div>
      <div><label for="regGuruNamaLengkap" class="block text-sm font-semibold text-gray-700 mb-2">Nama Lengkap <span class="text-red-500">*</span></label> <input type="text" id="regGuruNamaLengkap" required oninput="autoFillUsernamePassword()" class="input-focus w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-green-500 focus:outline-none transition-all" placeholder="Nama Lengkap Guru">
      </div>
      <div><label for="regGuruNIP" class="block text-sm font-semibold text-gray-700 mb-2">NIP</label> <input type="text" id="regGuruNIP" class="input-focus w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-green-500 focus:outline-none transition-all" placeholder="Boleh dikosongkan">
      </div>
      <div><label for="regGuruKelas" class="block text-sm font-semibold text-gray-700 mb-2">Kelas/Jabatan <span class="text-red-500">*</span></label> <select id="regGuruKelas" required class="input-focus w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-green-500 focus:outline-none transition-all"> <option value="">Pilih Kelas/Jabatan</option> <option value="Kepala Sekolah">Kepala Sekolah</option> <option value="1-A">Kelas 1-A</option> <option value="1-B">Kelas 1-B</option> <option value="1-C">Kelas 1-C</option> <option value="2-A">Kelas 2-A</option> <option value="2-B">Kelas 2-B</option> <option value="2-C">Kelas 2-C</option> <option value="3-A">Kelas 3-A</option> <option value="3-B">Kelas 3-B</option> <option value="3-C">Kelas 3-C</option> <option value="4-A">Kelas 4-A</option> <option value="4-B">Kelas 4-B</option> <option value="4-C">Kelas 4-C</option> <option value="5-A">Kelas 5-A</option> <option value="5-B">Kelas 5-B</option> <option value="5-C">Kelas 5-C</option> <option value="6-A">Kelas 6-A</option> <option value="6-B">Kelas 6-B</option> <option value="6-C">Kelas 6-C</option> <option value="Guru Agama">Guru Agama</option> <option value="Guru PJOK">Guru PJOK</option> <option value="Guru BDL">Guru BDL</option> <option value="Guru Inggris">Guru Inggris</option> <option value="Guru Koding">Guru Koding</option> <option value="Penjaga">Penjaga</option> <option value="Operator">Operator</option> <option value="Bendahara BoS/Arkas">Bendahara BoS/Arkas</option> <option value="Petugas Perpus">Petugas Perpus</option> <option value="Admin Lainnya">Admin Lainnya</option> </select>
      </div>
      <div><label for="regGuruGolongan" class="block text-sm font-semibold text-gray-700 mb-2">Golongan</label> <input type="text" id="regGuruGolongan" class="input-focus w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-green-500 focus:outline-none transition-all" placeholder="Contoh: III/a">
      </div>
      <div><label for="regGuruUsername" class="block text-sm font-semibold text-gray-700 mb-2">Username <span class="text-xs text-gray-500">(otomatis dari nama)</span></label> <input type="text" id="regGuruUsername" required readonly class="input-focus w-full px-4 py-3 border-2 border-gray-200 rounded-xl bg-gray-100 cursor-not-allowed transition-all" placeholder="Otomatis terisi dari nama">
      </div>
      <div><label for="regGuruPassword" class="block text-sm font-semibold text-gray-700 mb-2">Password <span class="text-xs text-gray-500">(otomatis dari nama)</span></label> <input type="text" id="regGuruPassword" required readonly class="input-focus w-full px-4 py-3 border-2 border-gray-200 rounded-xl bg-gray-100 cursor-not-allowed transition-all" placeholder="Otomatis terisi dari nama">
      </div><button type="submit" class="w-full bg-gradient-to-r from-green-600 to-green-700 text-white py-3 rounded-xl font-semibold hover:from-green-700 hover:to-green-800 transition-all shadow-lg"> Daftar Guru </button>
     </form>
     <div class="mt-4 text-center"><button onclick="showLogin()" class="text-green-600 hover:text-green-800 font-semibold"> ? Kembali ke Login </button>
     </div>
    </div>
   </div><!-- Dashboard Admin -->
   <div id="dashboardAdmin" class="hidden min-h-full bg-gray-100">
    <nav class="bg-white shadow-lg">
     <div class="max-w-7xl mx-auto px-6 py-4">
      <div class="flex justify-between items-center">
       <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-gradient-to-br from-red-500 to-red-600 rounded-full flex items-center justify-center"><span class="text-xl">?????</span>
        </div>
        <div>
         <h2 class="text-xl font-bold text-gray-800">Dashboard Admin</h2>
         <p class="text-sm text-gray-600" id="adminNameDisplay">Administrator</p>
        </div>
       </div><button onclick="handleLogout()" class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg font-medium transition-all"> Logout </button>
      </div>
     </div>
    </nav>
    <main class="max-w-7xl mx-auto p-6">
     <div class="bg-white rounded-2xl card-shadow p-6 mb-6">
      <h3 class="text-2xl font-bold text-gray-800 mb-4">Pengelolaan Admin</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
       <div><label class="block text-sm font-semibold text-gray-700 mb-2">Username Baru</label> <input type="text" id="adminNewUsername" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-red-500 focus:outline-none" placeholder="Username admin baru">
       </div>
       <div><label class="block text-sm font-semibold text-gray-700 mb-2">Password Baru</label> <input type="password" id="adminNewPassword" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-red-500 focus:outline-none" placeholder="Password">
       </div>
       <div class="flex items-end"><button onclick="addNewAdmin()" class="w-full bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium transition-all"> Tambah Admin </button>
       </div>
      </div>
      <div class="border-t pt-4">
       <h4 class="font-semibold text-gray-800 mb-3">Ganti Password Admin Saat Ini</h4>
       <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div><input type="password" id="adminChangePassword" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-red-500 focus:outline-none" placeholder="Password baru">
        </div>
        <div class="flex items-center"><button onclick="changeAdminPassword()" class="w-full bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-medium transition-all"> Ubah Password </button>
        </div>
       </div>
      </div>
     </div>
     <div class="bg-white rounded-2xl card-shadow p-6">
      <h3 class="text-2xl font-bold text-gray-800 mb-4">Daftar Sekolah Terdaftar</h3>
      <div class="overflow-x-auto">
       <table class="w-full">
        <thead class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white">
         <tr>
          <th class="px-6 py-4 text-left text-sm font-semibold rounded-tl-lg">No</th>
          <th class="px-6 py-4 text-left text-sm font-semibold">NPSN</th>
          <th class="px-6 py-4 text-left text-sm font-semibold">Nama Sekolah</th>
          <th class="px-6 py-4 text-left text-sm font-semibold">Username</th>
          <th class="px-6 py-4 text-left text-sm font-semibold">Tanggal Daftar</th>
          <th class="px-6 py-4 text-left text-sm font-semibold rounded-tr-lg">Aksi</th>
         </tr>
        </thead>
        <tbody id="adminSekolahTableBody">
         <tr>
          <td colspan="6" class="px-6 py-8 text-center text-gray-500">Belum ada sekolah terdaftar</td>
         </tr>
        </tbody>
       </table>
      </div>
     </div>
    </main>
   </div><!-- Dashboard Sekolah -->
   <div id="dashboardSekolah" class="hidden min-h-full bg-gray-100">
    <nav class="bg-white shadow-lg">
     <div class="max-w-7xl mx-auto px-6 py-4">
      <div class="flex justify-between items-center">
       <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center"><span class="text-xl">??</span>
        </div>
        <div>
         <h2 class="text-xl font-bold text-gray-800">Dashboard Sekolah</h2>
         <p class="text-sm text-gray-600" id="sekolahNameDisplay">Selamat datang!</p>
        </div>
       </div><button onclick="handleLogout()" class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg font-medium transition-all"> Logout </button>
      </div>
     </div>
    </nav>
    <main class="max-w-7xl mx-auto p-6" style="padding-bottom: 60px;">
     <div class="bg-white rounded-2xl card-shadow p-6 mb-6">
      <div class="flex justify-between items-center mb-4">
       <h3 class="text-xl font-bold text-gray-800">Profil Sekolah</h3><button onclick="toggleEditProfilSekolah()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all"> Edit </button>
      </div>
      <div id="viewProfilSekolah">
       <div class="space-y-2">
        <div class="flex border-b pb-2"><span class="text-sm text-gray-600 w-40">NPSN:</span> <span class="text-sm text-gray-800 font-semibold" id="viewNPSN">-</span>
        </div>
        <div class="flex border-b pb-2"><span class="text-sm text-gray-600 w-40">Nama Sekolah:</span> <span class="text-sm text-gray-800 font-semibold" id="viewNamaSekolah">-</span>
        </div>
        <div class="flex border-b pb-2"><span class="text-sm text-gray-600 w-40">Alamat:</span> <span class="text-sm text-gray-800 font-semibold" id="viewAlamat">-</span>
        </div>
        <div class="flex border-b pb-2"><span class="text-sm text-gray-600 w-40">Kepala Sekolah:</span> <span class="text-sm text-gray-800 font-semibold" id="viewKepalaSekolah">-</span>
        </div>
        <div class="flex border-b pb-2"><span class="text-sm text-gray-600 w-40">NIP Kepala:</span> <span class="text-sm text-gray-800 font-semibold" id="viewNIPKepala">-</span>
        </div>
        <div class="flex border-b pb-2"><span class="text-sm text-gray-600 w-40">Tempat TTD:</span> <span class="text-sm text-gray-800 font-semibold" id="viewTempatTTD">-</span>
        </div>
        <div class="flex border-b pb-2"><span class="text-sm text-gray-600 w-40">Tanggal TTD:</span> <span class="text-sm text-gray-800 font-semibold" id="viewTanggalTTD">-</span>
        </div>
       </div>
      </div>
      <div id="editProfilSekolah" class="hidden">
       <form onsubmit="saveProfilSekolah(event)" class="space-y-3">
        <div class="space-y-3">
         <div><label class="block text-xs font-semibold text-gray-700 mb-1">Alamat</label> <input type="text" id="editAlamat" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
         </div>
         <div><label class="block text-xs font-semibold text-gray-700 mb-1">Nama Kepala Sekolah</label> <input type="text" id="editKepalaSekolah" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
         </div>
         <div><label class="block text-xs font-semibold text-gray-700 mb-1">NIP Kepala Sekolah</label> <input type="text" id="editNIPKepala" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
         </div>
         <div><label class="block text-xs font-semibold text-gray-700 mb-1">Tempat Tanda Tangan</label> <input type="text" id="editTempatTTD" placeholder="Contoh: Jakarta" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
         </div>
         <div><label class="block text-xs font-semibold text-gray-700 mb-1">Tanggal Tanda Tangan</label> <input type="text" id="editTanggalTTD" readonly class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed">
         </div>
        </div>
        <div class="flex gap-2 pt-2"><button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all"> Simpan </button> <button type="button" onclick="toggleEditProfilSekolah()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all"> Batal </button>
        </div>
       </form>
      </div>
     </div>
     <div class="bg-white rounded-2xl card-shadow p-6 mb-6">
      <h3 class="text-xl font-bold text-gray-800 mb-3">Pengelolaan Akun</h3>
      <div class="flex gap-2"><input type="password" id="sekolahChangePassword" class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="Password baru"> <button onclick="changeSekolahPassword()" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all"> Ubah Password </button>
      </div>
     </div>
     <div class="bg-white rounded-2xl card-shadow p-6 mb-6">
      <h3 class="text-2xl font-bold text-gray-800 mb-4">Daftar Guru Terdaftar</h3>
      <div class="flex gap-3 mb-4"><button onclick="sortGuruByNama()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg font-medium transition-all"> Urutkan A-Z </button> <button onclick="hapusGuruGanda()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium transition-all"> Hapus Guru Ganda </button> <button onclick="simpanUrutanGuru()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium transition-all"> ?? Simpan Urutan </button>
      </div>
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
       <p class="text-sm text-blue-800"><strong>?? Cara Mengatur Urutan:</strong> Gunakan tombol ?? dan ?? untuk memindahkan guru ke atas/bawah. Klik <strong>Simpan Urutan</strong> setelah selesai mengatur.</p>
      </div>
      <div class="overflow-x-auto">
       <table class="w-full">
        <thead class="bg-gradient-to-r from-green-600 to-emerald-600 text-white">
         <tr>
          <th class="px-6 py-4 text-left text-sm font-semibold rounded-tl-lg">No</th>
          <th class="px-6 py-4 text-left text-sm font-semibold">Nama Guru</th>
          <th class="px-6 py-4 text-left text-sm font-semibold">Kelas</th>
          <th class="px-6 py-4 text-left text-sm font-semibold">Username</th>
          <th class="px-6 py-4 text-left text-sm font-semibold">Urutan</th>
          <th class="px-6 py-4 text-left text-sm font-semibold rounded-tr-lg">Aksi</th>
         </tr>
        </thead>
        <tbody id="sekolahGuruTableBody">
         <tr>
          <td colspan="6" class="px-6 py-8 text-center text-gray-500">Belum ada guru terdaftar</td>
         </tr>
        </tbody>
       </table>
      </div>
     </div><!-- TABEL PARAF DATANG -->
     <div class="bg-white rounded-2xl card-shadow p-6 mb-6">
      <div class="flex justify-between items-center mb-6">
       <h3 class="text-2xl font-bold text-green-700">?? Tabel Paraf Datang</h3><button onclick="cetakTabelParafDatang()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium transition-all flex items-center gap-2"> <span>???</span> <span>Cetak Paraf Datang</span> </button>
      </div>
      <div class="text-center mb-6">
       <h3 class="text-lg font-bold text-gray-800 uppercase" id="kopSekolahDatang">-</h3>
       <p class="text-xs text-gray-600" id="alamatSekolahDatang">-</p>
       <h3 class="text-md font-bold text-gray-800 uppercase mt-4">Daftar Hadir Guru</h3>
       <p class="text-sm text-gray-600" id="rekapBulanTahunDatang">-</p>
      </div>
      <div class="overflow-x-auto">
       <table class="w-full text-sm border-collapse border border-gray-300">
        <thead class="bg-gradient-to-r from-green-600 to-emerald-600 text-white">
         <tr>
          <th rowspan="2" class="px-4 py-3 text-center font-semibold border border-gray-300">No</th>
          <th rowspan="2" class="px-4 py-3 text-center font-semibold border border-gray-300">Nama Guru</th>
          <th rowspan="2" class="px-4 py-3 text-center font-semibold border border-gray-300">Gol</th>
          <th colspan="31" class="px-4 py-3 text-center font-semibold border border-gray-300">Tanggal</th>
         </tr>
         <tr id="rekapTanggalHeaderDatang">
         </tr>
        </thead>
        <tbody id="rekapAbsenDatangTableBody">
         <tr>
          <td colspan="35" class="px-6 py-8 text-center text-gray-500">Belum ada data absensi</td>
         </tr>
        </tbody>
       </table>
      </div>
     </div><!-- TABEL PARAF PULANG -->
     <div class="bg-white rounded-2xl card-shadow p-6 mb-6">
      <div class="flex justify-between items-center mb-6">
       <h3 class="text-2xl font-bold text-orange-700">?? Tabel Paraf Pulang</h3><button onclick="cetakTabelParafPulang()" class="bg-orange-600 hover:bg-orange-700 text-white px-6 py-2 rounded-lg font-medium transition-all flex items-center gap-2"> <span>???</span> <span>Cetak Paraf Pulang</span> </button>
      </div>
      <div class="text-center mb-6">
       <h3 class="text-lg font-bold text-gray-800 uppercase" id="kopSekolahPulang">-</h3>
       <p class="text-xs text-gray-600" id="alamatSekolahPulang">-</p>
       <h3 class="text-md font-bold text-gray-800 uppercase mt-4">Daftar Hadir Guru</h3>
       <p class="text-sm text-gray-600" id="rekapBulanTahunPulang">-</p>
      </div>
      <div class="overflow-x-auto">
       <table class="w-full text-sm border-collapse border border-gray-300">
        <thead class="bg-gradient-to-r from-orange-600 to-orange-500 text-white">
         <tr>
          <th rowspan="2" class="px-4 py-3 text-center font-semibold border border-gray-300">No</th>
          <th rowspan="2" class="px-4 py-3 text-center font-semibold border border-gray-300">Nama Guru</th>
          <th rowspan="2" class="px-4 py-3 text-center font-semibold border border-gray-300">Gol</th>
          <th colspan="31" class="px-4 py-3 text-center font-semibold border border-gray-300">Tanggal</th>
         </tr>
         <tr id="rekapTanggalHeaderPulang">
         </tr>
        </thead>
        <tbody id="rekapAbsenPulangTableBody">
         <tr>
          <td colspan="35" class="px-6 py-8 text-center text-gray-500">Belum ada data absensi</td>
         </tr>
        </tbody>
       </table>
      </div>
     </div><!-- TABEL REKAP ABSENSI -->
     <div class="bg-white rounded-2xl card-shadow p-6 mb-6">
      <div class="flex justify-between items-center mb-6">
       <h3 class="text-2xl font-bold text-gray-800">Rekap Absensi Bulan Ini</h3><button onclick="cetakTabelAbsen()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition-all flex items-center gap-2"> <span>???</span> <span>Cetak Tabel</span> </button>
      </div>
      <div class="text-center mb-6">
       <h3 class="text-lg font-bold text-gray-800 uppercase" id="kopSekolahRekap">-</h3>
       <p class="text-xs text-gray-600" id="alamatSekolahRekap">-</p>
       <h3 class="text-md font-bold text-gray-800 uppercase mt-4">Daftar Hadir Guru</h3>
       <p class="text-sm text-gray-600" id="rekapBulanTahun">-</p>
      </div>
      <div class="overflow-x-auto">
       <table class="w-full text-sm border-collapse border border-gray-300">
        <thead class="bg-gradient-to-r from-green-600 to-emerald-600 text-white">
         <tr>
          <th rowspan="2" class="px-4 py-3 text-center font-semibold border border-gray-300">No</th>
          <th rowspan="2" class="px-4 py-3 text-center font-semibold border border-gray-300">Nama Guru</th>
          <th rowspan="2" class="px-4 py-3 text-center font-semibold border border-gray-300">Gol</th>
          <th colspan="31" class="px-4 py-3 text-center font-semibold border border-gray-300">Tanggal</th>
         </tr>
         <tr id="rekapTanggalHeader">
         </tr>
        </thead>
        <tbody id="rekapAbsenTableBody">
         <tr>
          <td colspan="35" class="px-6 py-8 text-center text-gray-500">Belum ada data absensi</td>
         </tr>
        </tbody>
       </table>
      </div>
      <div class="mt-8 flex justify-end">
       <div class="text-center">
        <p id="ttdKepalaSekolahText" class="text-sm text-gray-700 mb-2">-</p>
        <p class="text-sm font-semibold text-gray-700 mb-16">Kepala Sekolah,</p>
        <div class="pt-2 min-w-[250px]">
         <p id="namaKepalaSekolahText" class="font-bold text-gray-800">-</p>
         <p id="nipKepalaSekolahText" class="text-sm text-gray-600">-</p>
        </div>
       </div>
      </div>
     </div>
    </main>
   </div><!-- Dashboard Guru -->
   <div id="dashboardGuru" class="hidden min-h-full bg-gray-100">
    <nav class="bg-white shadow-lg">
     <div class="max-w-7xl mx-auto px-6 py-4">
      <div class="flex justify-between items-center">
       <div class="flex items-center gap-6">
        <div class="flex items-center gap-3">
         <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-green-600 rounded-full flex items-center justify-center"><span class="text-xl">?????</span>
         </div>
         <div>
          <h2 class="text-xl font-bold text-gray-800">Dashboard Guru</h2>
          <p class="text-sm text-gray-600" id="guruNameDisplay">Selamat datang!</p>
         </div>
        </div>
        <div class="border-l-2 border-gray-300 pl-6">
         <div class="bg-blue-50 px-4 py-2 rounded-lg">
          <p class="text-xs text-blue-600 font-semibold">Sekolah</p>
          <p class="text-sm font-bold text-blue-800" id="guruSekolahName">-</p>
         </div>
        </div>
        <div class="bg-green-50 px-4 py-2 rounded-lg">
         <p class="text-xs text-green-600 font-semibold">Guru</p>
         <p class="text-sm font-bold text-green-800" id="guruKelasName">-</p>
        </div>
       </div><button onclick="handleLogout()" class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg font-medium transition-all"> Logout </button>
      </div>
     </div>
    </nav>
    <main class="max-w-7xl mx-auto p-6" style="padding-bottom: 60px;"><!-- Profil & Pengelolaan Akun Berdampingan -->
     <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"><!-- Profil Guru - Minimized -->
      <div class="bg-white rounded-2xl card-shadow overflow-hidden"><button onclick="toggleProfilGuru()" class="w-full flex items-center justify-between p-4 hover:bg-gray-50 transition-all">
        <div class="flex items-center gap-3"><span class="text-xl">??</span>
         <h3 class="text-base font-bold text-gray-800">Profil</h3>
        </div><span id="profilGuruIcon" class="text-gray-500 transition-transform">?</span> </button>
       <div id="profilGuruContent" class="hidden px-4 pb-4">
        <div class="space-y-2 text-sm">
         <div class="flex border-b pb-2"><span class="text-gray-600 w-24">Nama:</span> <span class="text-gray-800 font-semibold" id="guruProfilNama">-</span>
         </div>
         <div class="flex border-b pb-2"><span class="text-gray-600 w-24">NIP:</span> <span class="text-gray-800 font-semibold" id="guruProfilNIP">-</span>
         </div>
         <div class="flex border-b pb-2"><span class="text-gray-600 w-24">Kelas:</span> <span class="text-gray-800 font-semibold" id="guruProfilKelas">-</span>
         </div>
         <div class="flex pb-1"><span class="text-gray-600 w-24">Sekolah:</span> <span class="text-gray-800 font-semibold" id="guruProfilSekolah">-</span>
         </div>
        </div>
       </div>
      </div><!-- Pengelolaan Akun - Minimized -->
      <div class="bg-white rounded-2xl card-shadow overflow-hidden"><button onclick="toggleAkunGuru()" class="w-full flex items-center justify-between p-4 hover:bg-gray-50 transition-all">
        <div class="flex items-center gap-3"><span class="text-xl">??</span>
         <h3 class="text-base font-bold text-gray-800">Pengelolaan Akun</h3>
        </div><span id="akunGuruIcon" class="text-gray-500 transition-transform">?</span> </button>
       <div id="akunGuruContent" class="hidden px-4 pb-4">
        <div class="flex gap-2"><input type="password" id="guruChangePassword" class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:border-green-500 focus:outline-none" placeholder="Password baru"> <button onclick="changeGuruPassword()" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all"> Ubah </button>
        </div>
       </div>
      </div>
     </div><!-- Paraf Guru -->
     <div class="bg-white rounded-2xl card-shadow p-6 mb-6">
      <h3 class="text-xl font-bold text-gray-800 mb-2">Paraf Kehadiran</h3>
      <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
       <p class="text-sm font-semibold text-blue-800">? Paraf Datang: 06:00 - 08:30 WIB</p>
       <p class="text-sm font-semibold text-blue-800 mt-2">? Paraf Pulang: 11:30 - 13:00 WIB (Jumat: 10:30 - 13:00 WIB)</p>
       <p class="text-sm font-semibold text-red-700 mt-2">?? Hari Minggu tidak ada absensi</p>
      </div>
      <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 mb-6">
       <p class="text-sm font-semibold text-yellow-800 text-center">?? Beri PARAF pada Kolom Paraf (Bukan Tanda Tangan)</p>
       <p class="text-xs text-yellow-700 text-center mt-2">Usahakan di tengah kolom, lalu klik tombol kirim</p>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6"><!-- Paraf Masuk -->
       <div class="border-2 border-green-300 rounded-lg p-6 bg-green-50">
        <h4 class="text-lg font-semibold text-gray-800 mb-4 text-center">?? Paraf Datang</h4>
        <div class="bg-white border-2 border-green-300 rounded-lg mb-4 p-6">
         <div class="text-sm text-gray-600 mb-2 text-center">
          Kolom Paraf:
         </div>
         <canvas id="canvasMasuk" width="300" height="100" class="border-2 border-dashed border-green-400 rounded w-full" style="touch-action: none;"></canvas><button onclick="clearCanvasMasuk()" class="mt-2 text-xs text-red-600 hover:text-red-800 font-medium"> ????? Hapus Tanda Tangan </button>
        </div>
        <div class="mb-4"><button onclick="submitAbsenMasukGuru()" class="w-full bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-lg text-base font-bold transition-all shadow-lg"> ? Kirim Paraf Datang </button>
        </div>
        <div id="statusAbsenMasuk" class="text-center text-sm"></div>
        <div id="previewParafMasuk" class="hidden mt-4 border-2 border-green-400 rounded-lg p-4 bg-white">
         <p class="text-xs font-semibold text-green-700 mb-2 text-center">Paraf Terkirim:</p><img id="imgPreviewMasuk" src="" alt="Paraf Datang" class="w-full max-w-xs mx-auto border border-green-300 rounded" style="height: auto;">
        </div>
       </div><!-- Paraf Pulang -->
       <div class="border-2 border-orange-300 rounded-lg p-6 bg-orange-50">
        <h4 class="text-lg font-semibold text-gray-800 mb-4 text-center">?? Paraf Pulang</h4>
        <div class="bg-white border-2 border-orange-300 rounded-lg mb-4 p-6">
         <div class="text-sm text-gray-600 mb-2 text-center">
          Kolom Paraf:
         </div>
         <canvas id="canvasPulang" width="300" height="100" class="border-2 border-dashed border-orange-400 rounded w-full" style="touch-action: none;"></canvas><button onclick="clearCanvasPulang()" class="mt-2 text-xs text-red-600 hover:text-red-800 font-medium"> ??? Hapus Tanda Tangan </button>
        </div>
        <div class="mb-4"><button onclick="submitAbsenPulangGuru()" class="w-full bg-orange-500 hover:bg-orange-600 text-white px-4 py-3 rounded-lg text-base font-bold transition-all shadow-lg"> ? Kirim Paraf Pulang </button>
        </div>
        <div id="statusAbsenPulang" class="text-center text-sm"></div>
        <div id="previewParafPulang" class="hidden mt-4 border-2 border-orange-400 rounded-lg p-4 bg-white">
         <p class="text-xs font-semibold text-orange-700 mb-2 text-center">Paraf Terkirim:</p><img id="imgPreviewPulang" src="" alt="Paraf Pulang" class="w-full max-w-xs mx-auto border border-orange-300 rounded" style="height: auto;">
        </div>
       </div>
      </div>
     </div>
    </main>
   </div>
  </div>
  <script>
    let allData = [];
    let currentUser = null;
    let sdkInitialized = false;

    const dataHandler = {
      onDataChanged(data) {
        allData = data;
        updateAllDashboards();
      }
    };

    async function init() {
      loadSavedAccounts();
      
      let retries = 0;
      const maxRetries = 50;
      
      while (retries < maxRetries) {
        if (window.dataSdk) {
          try {
            const result = await window.dataSdk.init(dataHandler);
            if (result.isOk) {
              sdkInitialized = true;
              console.log('? SDK siap');
              return;
            }
          } catch (error) {
            console.log('Mencoba ulang...');
          }
        }
        await new Promise(resolve => setTimeout(resolve, 100));
        retries++;
      }
      
      sdkInitialized = false;
      console.warn('?? SDK tidak tersedia');
    }
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

    function loadSavedAccounts() {
      const savedAccounts = JSON.parse(localStorage.getItem('savedAccounts') || '[]');
      
      if (savedAccounts.length > 0) {
        document.getElementById('savedAccountsSection').style.display = 'block';
        
        const accountsList = document.getElementById('savedAccountsList');
        accountsList.innerHTML = savedAccounts.map(account => {
          const icon = account.tipe === 'guru' ? '?????' : account.tipe === 'sekolah' ? '??' : '?????';
          const color = account.tipe === 'guru' ? 'green' : account.tipe === 'sekolah' ? 'blue' : 'red';
          
          return `
            <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg border-2 border-${color}-200">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-${color}-100 rounded-full flex items-center justify-center">
                  <span class="text-xl">${icon}</span>
                </div>
                <div>
                  <p class="font-semibold text-gray-800 text-sm">${account.username}</p>
                  <p class="text-xs text-gray-500">${account.namaLengkap || account.namaSekolah || 'Admin'}</p>
                </div>
              </div>
              <div class="flex gap-2">
                <button onclick="quickLogin('${account.username}', '${account.password}', '${account.tipe}')" class="bg-${color}-500 hover:bg-${color}-600 text-white px-4 py-2 rounded-lg text-xs font-medium transition-all">
                  Masuk
                </button>
                <button onclick="removeSavedAccount('${account.username}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-xs font-medium transition-all">
                  ???
                </button>
              </div>
            </div>
          `;
        }).join('');
      } else {
        document.getElementById('savedAccountsSection').style.display = 'none';
      }
    }

    function quickLogin(username, password, tipe) {
      document.getElementById('loginUsername').value = username;
      document.getElementById('loginPassword').value = password;
      
      const form = document.querySelector('#loginForm form');
      form.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
    }

    function removeSavedAccount(username) {
      let savedAccounts = JSON.parse(localStorage.getItem('savedAccounts') || '[]');
      savedAccounts = savedAccounts.filter(acc => acc.username !== username);
      localStorage.setItem('savedAccounts', JSON.stringify(savedAccounts));
      loadSavedAccounts();
      showToast('??? Akun tersimpan dihapus!', 'success');
    }

    function saveAccount(username, password, tipe, namaLengkap, namaSekolah) {
      let savedAccounts = JSON.parse(localStorage.getItem('savedAccounts') || '[]');
      
      const existingIndex = savedAccounts.findIndex(acc => acc.username === username);
      if (existingIndex >= 0) {
        savedAccounts.splice(existingIndex, 1);
      }
      
      savedAccounts.unshift({
        username,
        password,
        tipe,
        namaLengkap,
        namaSekolah,
        savedAt: new Date().toISOString()
      });
      
      if (savedAccounts.length > 5) {
        savedAccounts = savedAccounts.slice(0, 5);
      }
      
      localStorage.setItem('savedAccounts', JSON.stringify(savedAccounts));
    }

    function showLogin() {
      hideAllViews();
      document.getElementById('loginForm').classList.remove('hidden');
    }

    function showRegisterSekolah() {
      hideAllViews();
      document.getElementById('registerSekolahForm').classList.remove('hidden');
    }

    function showRegisterGuru() {
      hideAllViews();
      document.getElementById('registerGuruForm').classList.remove('hidden');
    }

    function hideAllViews() {
      document.getElementById('loginForm').classList.add('hidden');
      document.getElementById('registerSekolahForm').classList.add('hidden');
      document.getElementById('registerGuruForm').classList.add('hidden');
      document.getElementById('dashboardAdmin').classList.add('hidden');
      document.getElementById('dashboardSekolah').classList.add('hidden');
      document.getElementById('dashboardGuru').classList.add('hidden');
    }

    async function handleRegisterSekolah(e) {
      e.preventDefault();
      
      if (allData.length >= 999) {
        showToast('?? Maksimum 999 data tercapai', 'error');
        return;
      }

      const npsn = document.getElementById('regSekolahNPSN').value;
      const namaSekolah = document.getElementById('regSekolahNama').value;
      const username = document.getElementById('regSekolahUsername').value;
      const password = document.getElementById('regSekolahPassword').value;

      const npsnExists = allData.some(d => d.npsn === npsn && d.tipe === 'sekolah');
      if (npsnExists) {
        showToast('?? NPSN sudah terdaftar! Pendaftaran hanya dapat dilakukan 1 kali.', 'error');
        return;
      }

      const usernameExists = allData.some(d => d.username === username && d.tipe === 'sekolah');
      if (usernameExists) {
        showToast('?? Username sudah digunakan! Pendaftaran hanya dapat dilakukan 1 kali.', 'error');
        return;
      }

      const namaSekolahExists = allData.some(d => d.nama_sekolah && d.nama_sekolah.toLowerCase() === namaSekolah.toLowerCase() && d.tipe === 'sekolah');
      if (namaSekolahExists) {
        showToast('?? Nama sekolah sudah terdaftar! Pendaftaran hanya dapat dilakukan 1 kali.', 'error');
        return;
      }

      showToast('? Mendaftarkan sekolah...', 'info');

      const result = await window.dataSdk.create({
        tipe: 'sekolah',
        username: username,
        password: password,
        npsn: npsn,
        nama_sekolah: namaSekolah,
        alamat_sekolah: '',
        nama_kepala_sekolah: '',
        nip_kepala: '',
        tempat_ttd: '',
        tanggal_ttd: '',
        tanggal_daftar: new Date().toISOString()
      });

      if (result.isOk) {
        showToast('? Registrasi sekolah berhasil!', 'success');
        e.target.reset();
        setTimeout(() => showLogin(), 1500);
      } else {
        showToast('? Registrasi gagal. Coba lagi.', 'error');
      }
    }

    function autoFillNamaSekolah() {
      const npsn = document.getElementById('regGuruNPSN').value.trim();
      const namaSekolahInput = document.getElementById('regGuruNamaSekolah');
      
      if (!npsn) {
        namaSekolahInput.value = '';
        return;
      }
      
      const sekolah = allData.find(d => d.tipe === 'sekolah' && d.npsn === npsn);
      
      if (sekolah) {
        namaSekolahInput.value = sekolah.nama_sekolah;
        namaSekolahInput.classList.remove('bg-gray-100');
        namaSekolahInput.classList.add('bg-green-50');
      } else {
        namaSekolahInput.value = '';
        namaSekolahInput.classList.remove('bg-green-50');
        namaSekolahInput.classList.add('bg-gray-100');
      }
    }

    function autoFillUsernamePassword() {
      const namaLengkap = document.getElementById('regGuruNamaLengkap').value.trim();
      const usernameInput = document.getElementById('regGuruUsername');
      const passwordInput = document.getElementById('regGuruPassword');
      
      if (!namaLengkap) {
        usernameInput.value = '';
        passwordInput.value = '';
        return;
      }
      
      // Hapus gelar dari nama
      let namaTanpaGelar = namaLengkap;
      
      // Daftar gelar yang akan dihapus (depan dan belakang)
      const gelarDepan = ['dr.', 'dr', 'drs.', 'drs', 'dra.', 'dra', 'prof.', 'prof', 'ir.', 'ir', 'h.', 'h', 'hj.', 'hj', 'kh.', 'kh', 'r.', 'r', 'raden', 'rd.', 'rd'];
      const gelarBelakang = ['m.pd.', 'm.pd', 'mpd', 's.pd.', 's.pd', 'spd', 's.ag.', 's.ag', 'sag', 's.kom.', 's.kom', 'skom', 's.t.', 's.t', 'st', 's.e.', 's.e', 'se', 's.h.', 's.h', 'sh', 's.sos.', 's.sos', 'ssos', 'm.m.', 'm.m', 'mm', 'm.si.', 'm.si', 'msi', 'm.kom.', 'm.kom', 'mkom', 'ph.d.', 'ph.d', 'phd', 'dr.', 'dr', 'm.a.', 'm.a', 'ma', 'm.sc.', 'm.sc', 'msc', 'b.a.', 'b.a', 'ba', 'lc.', 'lc', 'm.ag.', 'm.ag', 'mag', 's.i.', 's.i', 'si', 's.ip.', 's.ip', 'sip', 's.ikom.', 's.ikom', 'sikom', 'gr.', 'gr'];
      
      // Hapus gelar depan
      gelarDepan.forEach(gelar => {
        const regex = new RegExp('^' + gelar.replace('.', '\\.') + '\\s*', 'gi');
        namaTanpaGelar = namaTanpaGelar.replace(regex, '');
      });
      
      // Hapus gelar belakang (setelah koma atau langsung)
      gelarBelakang.forEach(gelar => {
        const regex1 = new RegExp(',?\\s*' + gelar.replace('.', '\\.') + '\\s*$', 'gi');
        const regex2 = new RegExp(',?\\s*' + gelar.replace('.', '\\.') + '\\s*,', 'gi');
        namaTanpaGelar = namaTanpaGelar.replace(regex1, '');
        namaTanpaGelar = namaTanpaGelar.replace(regex2, ',');
      });
      
      // Bersihkan koma berlebih dan spasi
      namaTanpaGelar = namaTanpaGelar.replace(/,+/g, '').trim();
      
      // Buat username: huruf kecil, tanpa spasi
      const username = namaTanpaGelar.toLowerCase().replace(/\s+/g, '');
      
      usernameInput.value = username;
      passwordInput.value = username;
      
      // Ubah warna untuk menunjukkan terisi otomatis
      usernameInput.classList.remove('bg-gray-100');
      usernameInput.classList.add('bg-green-50');
      passwordInput.classList.remove('bg-gray-100');
      passwordInput.classList.add('bg-green-50');
    }

    async function handleRegisterGuru(e) {
      e.preventDefault();
      
      if (allData.length >= 999) {
        showToast('?? Maksimum 999 data tercapai', 'error');
        return;
      }

      const npsn = document.getElementById('regGuruNPSN').value;
      const namaSekolah = document.getElementById('regGuruNamaSekolah').value;
      const namaLengkap = document.getElementById('regGuruNamaLengkap').value;
      const nip = document.getElementById('regGuruNIP').value;
      const kelas = document.getElementById('regGuruKelas').value;
      const golongan = document.getElementById('regGuruGolongan').value;
      const username = document.getElementById('regGuruUsername').value;
      const password = document.getElementById('regGuruPassword').value;

      const sekolahExists = allData.some(d => d.tipe === 'sekolah' && d.npsn === npsn && d.nama_sekolah === namaSekolah);
      if (!sekolahExists) {
        showToast('?? NPSN/Sekolah tidak sama. Hubungi Admin Sekolah!', 'error');
        return;
      }

      const usernameExists = allData.some(d => d.username === username && d.tipe === 'guru');
      if (usernameExists) {
        showToast('?? Username sudah digunakan! Pendaftaran hanya dapat dilakukan 1 kali.', 'error');
        return;
      }

      const namaGuruExists = allData.some(d => 
        d.nama_lengkap && 
        d.nama_lengkap.toLowerCase() === namaLengkap.toLowerCase() && 
        d.npsn === npsn && 
        d.tipe === 'guru'
      );
      if (namaGuruExists) {
        showToast('?? Nama guru sudah terdaftar di sekolah ini! Pendaftaran hanya dapat dilakukan 1 kali.', 'error');
        return;
      }

      showToast('? Mendaftarkan guru...', 'info');

      const result = await window.dataSdk.create({
        tipe: 'guru',
        username: username,
        password: password,
        npsn: npsn,
        nama_sekolah: namaSekolah,
        nama_lengkap: namaLengkap,
        nip: nip,
        kelas: kelas,
        golongan: golongan,
        tanggal_daftar: new Date().toISOString(),
        urutan_absen: 999999
      });

      if (result.isOk) {
        showToast('? Registrasi guru berhasil!', 'success');
        e.target.reset();
        setTimeout(() => showLogin(), 1500);
      } else {
        showToast('? Registrasi gagal. Coba lagi.', 'error');
      }
    }

    function handleLogin(e) {
      e.preventDefault();

      const username = document.getElementById('loginUsername').value;
      const password = document.getElementById('loginPassword').value;
      const rememberMe = document.getElementById('rememberMe').checked;

      // Cek login admin dari database
      const adminUser = allData.find(d => d.tipe === 'admin' && d.username === username && d.password === password);
      
      if (adminUser) {
        currentUser = adminUser;
        
        if (rememberMe) {
          saveAccount(username, password, 'admin', null, null);
        }
        
        hideAllViews();
        document.getElementById('dashboardAdmin').classList.remove('hidden');
        updateAdminDashboard();
        showToast('? Login Admin berhasil!', 'success');
        return;
      }
      
      // Fallback ke admin default (username: admin, password: admin)
      if (username === 'admin' && password === 'admin') {
        currentUser = { tipe: 'admin', username: 'admin' };
        
        if (rememberMe) {
          saveAccount(username, password, 'admin', null, null);
        }
        
        hideAllViews();
        document.getElementById('dashboardAdmin').classList.remove('hidden');
        updateAdminDashboard();
        showToast('? Login Admin berhasil!', 'success');
        return;
      }

      const user = allData.find(d => d.username === username && d.password === password);

      if (!user) {
        showToast('? Username atau password salah!', 'error');
        return;
      }

      currentUser = user;

      if (rememberMe) {
        saveAccount(
          username, 
          password, 
          user.tipe, 
          user.nama_lengkap || null, 
          user.nama_sekolah || null
        );
        loadSavedAccounts();
      }

      if (user.tipe === 'sekolah') {
        hideAllViews();
        document.getElementById('dashboardSekolah').classList.remove('hidden');
        updateSekolahDashboard();
        showToast('? Login berhasil!', 'success');
      } else if (user.tipe === 'guru') {
        hideAllViews();
        document.getElementById('dashboardGuru').classList.remove('hidden');
        updateGuruDashboard();
        showToast('? Login berhasil!', 'success');
      }
    }

    function handleLogout() {
      currentUser = null;
      document.getElementById('loginUsername').value = '';
      document.getElementById('loginPassword').value = '';
      showLogin();
      showToast('?? Logout berhasil!', 'info');
    }

    function updateAllDashboards() {
      if (!currentUser) return;

      if (currentUser.tipe === 'admin') {
        updateAdminDashboard();
      } else if (currentUser.tipe === 'sekolah') {
        updateSekolahDashboard();
      } else if (currentUser.tipe === 'guru') {
        updateGuruDashboard();
      }
    }

    function updateAdminDashboard() {
      const sekolahList = allData.filter(d => d.tipe === 'sekolah');
      const tableBody = document.getElementById('adminSekolahTableBody');

      if (tableBody) {
        if (sekolahList.length === 0) {
          tableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-gray-500">Belum ada sekolah terdaftar</td></tr>';
        } else {
          tableBody.innerHTML = sekolahList.map((sekolah, index) => `
            <tr class="border-b border-gray-200 hover:bg-blue-50 transition-colors">
              <td class="px-6 py-4 text-sm text-gray-800">${index + 1}</td>
              <td class="px-6 py-4 text-sm font-semibold text-gray-800">${sekolah.npsn}</td>
              <td class="px-6 py-4 text-sm text-gray-600">${sekolah.nama_sekolah}</td>
              <td class="px-6 py-4 text-sm text-gray-600">${sekolah.username}</td>
              <td class="px-6 py-4 text-sm text-gray-600">${new Date(sekolah.tanggal_daftar).toLocaleDateString('id-ID')}</td>
              <td class="px-6 py-4 text-sm">
                <button onclick="deleteSekolah('${sekolah.__backendId}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs font-medium">
                  Hapus
                </button>
              </td>
            </tr>
          `).join('');
        }
      }
    }

    async function deleteSekolah(backendId) {
      const sekolah = allData.find(d => d.__backendId === backendId);
      if (!sekolah) return;

      const result = await window.dataSdk.delete(sekolah);
      if (result.isOk) {
        showToast('? Sekolah berhasil dihapus!', 'success');
      } else {
        showToast('??? Gagal menghapus sekolah!', 'error');
      }
    }

    async function addNewAdmin() {
      const username = document.getElementById('adminNewUsername').value;
      const password = document.getElementById('adminNewPassword').value;

      if (!username || !password) {
        showToast('?? Username dan password harus diisi!', 'error');
        return;
      }

      if (allData.length >= 999) {
        showToast('?? Maksimum 999 data tercapai', 'error');
        return;
      }

      const usernameExists = allData.some(d => d.username === username && d.tipe === 'admin');
      if (usernameExists) {
        showToast('?? Username admin sudah digunakan!', 'error');
        return;
      }

      showToast('? Menambahkan admin baru...', 'info');

      const result = await window.dataSdk.create({
        tipe: 'admin',
        username: username,
        password: password,
        tanggal_daftar: new Date().toISOString()
      });

      if (result.isOk) {
        showToast('? Admin baru berhasil ditambahkan!', 'success');
        document.getElementById('adminNewUsername').value = '';
        document.getElementById('adminNewPassword').value = '';
      } else {
        showToast('? Gagal menambahkan admin!', 'error');
      }
    }

    async function changeAdminPassword() {
      const newPassword = document.getElementById('adminChangePassword').value;
      if (!newPassword) {
        showToast('?? Password baru harus diisi!', 'error');
        return;
      }

      if (!currentUser || currentUser.tipe !== 'admin') {
        showToast('?? Hanya admin yang bisa mengubah password!', 'error');
        return;
      }

      const adminData = allData.find(d => d.tipe === 'admin' && d.username === currentUser.username);
      
      if (!adminData) {
        showToast('?? Data admin tidak ditemukan!', 'error');
        return;
      }

      showToast('? Mengubah password...', 'info');

      const updatedAdmin = {
        ...adminData,
        password: newPassword
      };

      const result = await window.dataSdk.update(updatedAdmin);

      if (result.isOk) {
        currentUser.password = newPassword;
        showToast('? Password admin berhasil diubah!', 'success');
        document.getElementById('adminChangePassword').value = '';
      } else {
        showToast('? Gagal mengubah password!', 'error');
      }
    }

    let tempGuruOrder = [];

    function updateSekolahDashboard() {
      if (!currentUser || currentUser.tipe !== 'sekolah') return;

      document.getElementById('sekolahNameDisplay').textContent = currentUser.nama_sekolah;

      document.getElementById('viewNPSN').textContent = currentUser.npsn || '-';
      document.getElementById('viewNamaSekolah').textContent = currentUser.nama_sekolah || '-';
      document.getElementById('viewAlamat').textContent = currentUser.alamat_sekolah || '-';
      document.getElementById('viewKepalaSekolah').textContent = currentUser.nama_kepala_sekolah || '-';
      document.getElementById('viewNIPKepala').textContent = currentUser.nip_kepala || '-';
      document.getElementById('viewTempatTTD').textContent = currentUser.tempat_ttd || '-';
      document.getElementById('viewTanggalTTD').textContent = currentUser.tanggal_ttd || '-';

      let guruList = allData.filter(d => d.tipe === 'guru' && d.npsn === currentUser.npsn);
      
      guruList.sort((a, b) => {
        const orderA = a.urutan_absen !== undefined && a.urutan_absen !== null ? parseInt(a.urutan_absen) : 999999;
        const orderB = b.urutan_absen !== undefined && b.urutan_absen !== null ? parseInt(b.urutan_absen) : 999999;
        return orderA - orderB;
      });

      tempGuruOrder = guruList.map(g => g.__backendId);
      
      const tableBody = document.getElementById('sekolahGuruTableBody');

      if (tableBody) {
        if (guruList.length === 0) {
          tableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-gray-500">Belum ada guru terdaftar</td></tr>';
        } else {
          tableBody.innerHTML = guruList.map((guru, index) => `
            <tr class="border-b border-gray-200 hover:bg-green-50 transition-colors">
              <td class="px-6 py-4 text-sm text-gray-800">${index + 1}</td>
              <td class="px-6 py-4 text-sm">
                <div class="font-semibold text-gray-800">${guru.nama_lengkap}</div>
                <div class="text-xs text-gray-500 mt-1">NIP: ${guru.nip || '-'}</div>
              </td>
              <td class="px-6 py-4 text-sm text-gray-600">${guru.kelas}</td>
              <td class="px-6 py-4 text-sm text-gray-600">${guru.username}</td>
              <td class="px-6 py-4 text-sm">
                <div class="flex gap-1">
                  <button onclick="moveGuruUp(${index})" ${index === 0 ? 'disabled' : ''} class="bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-white px-2 py-1 rounded text-xs font-medium">
                    ??
                  </button>
                  <button onclick="moveGuruDown(${index})" ${index === guruList.length - 1 ? 'disabled' : ''} class="bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-white px-2 py-1 rounded text-xs font-medium">
                    ??
                  </button>
                </div>
              </td>
              <td class="px-6 py-4 text-sm">
                <button onclick="deleteGuru('${guru.__backendId}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs font-medium">
                  Hapus
                </button>
              </td>
            </tr>
          `).join('');
        }
      }

      updateRekapAbsen();
    }

    function moveGuruUp(index) {
      if (index === 0) return;
      
      [tempGuruOrder[index], tempGuruOrder[index - 1]] = [tempGuruOrder[index - 1], tempGuruOrder[index]];
      
      renderGuruTableFromTempOrder();
    }

    function moveGuruDown(index) {
      if (index >= tempGuruOrder.length - 1) return;
      
      [tempGuruOrder[index], tempGuruOrder[index + 1]] = [tempGuruOrder[index + 1], tempGuruOrder[index]];
      
      renderGuruTableFromTempOrder();
    }

    function renderGuruTableFromTempOrder() {
      const guruList = tempGuruOrder.map(id => allData.find(d => d.__backendId === id)).filter(Boolean);
      
      const tableBody = document.getElementById('sekolahGuruTableBody');

      if (tableBody && guruList.length > 0) {
        tableBody.innerHTML = guruList.map((guru, index) => `
          <tr class="border-b border-gray-200 hover:bg-green-50 transition-colors">
            <td class="px-6 py-4 text-sm text-gray-800">${index + 1}</td>
            <td class="px-6 py-4 text-sm">
              <div class="font-semibold text-gray-800">${guru.nama_lengkap}</div>
              <div class="text-xs text-gray-500 mt-1">NIP: ${guru.nip || '-'}</div>
            </td>
            <td class="px-6 py-4 text-sm text-gray-600">${guru.kelas}</td>
            <td class="px-6 py-4 text-sm text-gray-600">${guru.username}</td>
            <td class="px-6 py-4 text-sm">
              <div class="flex gap-1">
                <button onclick="moveGuruUp(${index})" ${index === 0 ? 'disabled' : ''} class="bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-white px-2 py-1 rounded text-xs font-medium">
                  ????
                </button>
                <button onclick="moveGuruDown(${index})" ${index === guruList.length - 1 ? 'disabled' : ''} class="bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-white px-2 py-1 rounded text-xs font-medium">
                  ??
                </button>
              </div>
            </td>
            <td class="px-6 py-4 text-sm">
              <button onclick="deleteGuru('${guru.__backendId}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs font-medium">
                Hapus
              </button>
            </td>
          </tr>
        `).join('');
      }
    }

    async function simpanUrutanGuru() {
      showToast('? Menyimpan urutan guru...', 'info');

      let successCount = 0;
      let errorCount = 0;

      for (let i = 0; i < tempGuruOrder.length; i++) {
        const guruBackendId = tempGuruOrder[i];
        const guru = allData.find(d => d.__backendId === guruBackendId);
        
        if (!guru) continue;

        const updatedGuru = {
          ...guru,
          urutan_absen: i
        };

        const result = await window.dataSdk.update(updatedGuru);

        if (result.isOk) {
          successCount++;
        } else {
          errorCount++;
        }
      }

      if (errorCount === 0) {
        showToast(`? Urutan ${successCount} guru berhasil disimpan!`, 'success');
      } else {
        showToast(`?? ${successCount} berhasil, ${errorCount} gagal`, 'error');
      }
    }

    function sortGuruByNama() {
      let guruList = allData.filter(d => d.tipe === 'guru' && d.npsn === currentUser.npsn);
      
      guruList.sort((a, b) => a.nama_lengkap.localeCompare(b.nama_lengkap));
      
      tempGuruOrder = guruList.map(g => g.__backendId);
      
      renderGuruTableFromTempOrder();
      
      showToast('?? Guru diurutkan A-Z. Klik Simpan Urutan untuk menyimpan!', 'info');
    }

    async function deleteGuru(backendId) {
      const guru = allData.find(d => d.__backendId === backendId);
      if (!guru) return;

      const result = await window.dataSdk.delete(guru);
      if (result.isOk) {
        showToast('? Guru berhasil dihapus!', 'success');
      } else {
        showToast('? Gagal menghapus guru!', 'error');
      }
    }

    function toggleEditProfilSekolah() {
      const viewSection = document.getElementById('viewProfilSekolah');
      const editSection = document.getElementById('editProfilSekolah');

      if (editSection.classList.contains('hidden')) {
        document.getElementById('editAlamat').value = currentUser.alamat_sekolah || '';
        document.getElementById('editKepalaSekolah').value = currentUser.nama_kepala_sekolah || '';
        document.getElementById('editNIPKepala').value = currentUser.nip_kepala || '';
        document.getElementById('editTempatTTD').value = currentUser.tempat_ttd || '';
        
        const today = new Date();
        const options = { day: 'numeric', month: 'long', year: 'numeric' };
        const tanggalIndo = today.toLocaleDateString('id-ID', options);
        document.getElementById('editTanggalTTD').value = tanggalIndo;

        viewSection.classList.add('hidden');
        editSection.classList.remove('hidden');
      } else {
        viewSection.classList.remove('hidden');
        editSection.classList.add('hidden');
      }
    }

    async function saveProfilSekolah(e) {
      e.preventDefault();

      showToast('? Menyimpan perubahan...', 'info');

      const updatedUser = {
        ...currentUser,
        alamat_sekolah: document.getElementById('editAlamat').value,
        nama_kepala_sekolah: document.getElementById('editKepalaSekolah').value,
        nip_kepala: document.getElementById('editNIPKepala').value,
        tempat_ttd: document.getElementById('editTempatTTD').value,
        tanggal_ttd: document.getElementById('editTanggalTTD').value
      };

      const result = await window.dataSdk.update(updatedUser);

      if (result.isOk) {
        currentUser = updatedUser;
        
        document.getElementById('viewNPSN').textContent = currentUser.npsn || '-';
        document.getElementById('viewNamaSekolah').textContent = currentUser.nama_sekolah || '-';
        document.getElementById('viewAlamat').textContent = currentUser.alamat_sekolah || '-';
        document.getElementById('viewKepalaSekolah').textContent = currentUser.nama_kepala_sekolah || '-';
        document.getElementById('viewNIPKepala').textContent = currentUser.nip_kepala || '-';
        document.getElementById('viewTempatTTD').textContent = currentUser.tempat_ttd || '-';
        document.getElementById('viewTanggalTTD').textContent = currentUser.tanggal_ttd || '-';
        
        updateRekapAbsen();
        
        showToast('? Profil berhasil diperbarui!', 'success');
        toggleEditProfilSekolah();
      } else {
        showToast('? Gagal menyimpan perubahan!', 'error');
      }
    }

    async function changeSekolahPassword() {
      const newPassword = document.getElementById('sekolahChangePassword').value;
      if (!newPassword) {
        showToast('?? Password baru harus diisi!', 'error');
        return;
      }

      showToast('? Mengubah password...', 'info');

      const updatedUser = {
        ...currentUser,
        password: newPassword
      };

      const result = await window.dataSdk.update(updatedUser);

      if (result.isOk) {
        currentUser = updatedUser;
        showToast('? Password berhasil diubah!', 'success');
        document.getElementById('sekolahChangePassword').value = '';
      } else {
        showToast('? Gagal mengubah password!', 'error');
      }
    }

    function hapusGuruGanda() {
      const guruList = allData.filter(d => d.tipe === 'guru' && d.npsn === currentUser.npsn);
      const uniqueGuru = new Map();

      guruList.forEach(guru => {
        const key = guru.nama_lengkap + guru.nip;
        if (!uniqueGuru.has(key)) {
          uniqueGuru.set(key, guru);
        }
      });

      showToast('????????? Data guru ganda sudah dibersihkan!', 'info');
    }



    let canvasMasukInitialized = false;
    let canvasPulangInitialized = false;
    let ctxMasuk, ctxPulang;
    let isDrawingMasuk = false;
    let isDrawingPulang = false;

    function initSignatureCanvas() {
      const canvasMasuk = document.getElementById('canvasMasuk');
      const canvasPulang = document.getElementById('canvasPulang');
      
      if (!canvasMasuk || !canvasPulang) {
        setTimeout(initSignatureCanvas, 100);
        return;
      }
      
      if (!canvasMasukInitialized) {
        ctxMasuk = canvasMasuk.getContext('2d');
        ctxMasuk.strokeStyle = '#000000';
        ctxMasuk.lineWidth = 2;
        ctxMasuk.lineCap = 'round';
        ctxMasuk.lineJoin = 'round';
        
        canvasMasuk.addEventListener('mousedown', startDrawingMasuk);
        canvasMasuk.addEventListener('mousemove', drawMasuk);
        canvasMasuk.addEventListener('mouseup', stopDrawingMasuk);
        canvasMasuk.addEventListener('mouseleave', stopDrawingMasuk);
        
        canvasMasuk.addEventListener('touchstart', handleTouchStartMasuk, {passive: false});
        canvasMasuk.addEventListener('touchmove', handleTouchMoveMasuk, {passive: false});
        canvasMasuk.addEventListener('touchend', stopDrawingMasuk);
        
        canvasMasukInitialized = true;
      }
      
      if (!canvasPulangInitialized) {
        ctxPulang = canvasPulang.getContext('2d');
        ctxPulang.strokeStyle = '#000000';
        ctxPulang.lineWidth = 2;
        ctxPulang.lineCap = 'round';
        ctxPulang.lineJoin = 'round';
        
        canvasPulang.addEventListener('mousedown', startDrawingPulang);
        canvasPulang.addEventListener('mousemove', drawPulang);
        canvasPulang.addEventListener('mouseup', stopDrawingPulang);
        canvasPulang.addEventListener('mouseleave', stopDrawingPulang);
        
        canvasPulang.addEventListener('touchstart', handleTouchStartPulang, {passive: false});
        canvasPulang.addEventListener('touchmove', handleTouchMovePulang, {passive: false});
        canvasPulang.addEventListener('touchend', stopDrawingPulang);
        
        canvasPulangInitialized = true;
      }
    }

    function getCanvasCoordinates(canvas, clientX, clientY) {
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      
      return {
        x: (clientX - rect.left) * scaleX,
        y: (clientY - rect.top) * scaleY
      };
    }

    function startDrawingMasuk(e) {
      isDrawingMasuk = true;
      const canvas = e.target;
      const coords = getCanvasCoordinates(canvas, e.clientX, e.clientY);
      
      ctxMasuk.beginPath();
      ctxMasuk.moveTo(coords.x, coords.y);
    }

    function drawMasuk(e) {
      if (!isDrawingMasuk) return;
      
      const canvas = e.target;
      const coords = getCanvasCoordinates(canvas, e.clientX, e.clientY);
      
      ctxMasuk.lineTo(coords.x, coords.y);
      ctxMasuk.stroke();
    }

    function stopDrawingMasuk() {
      isDrawingMasuk = false;
    }

    function handleTouchStartMasuk(e) {
      e.preventDefault();
      const touch = e.touches[0];
      const canvas = e.target;
      
      isDrawingMasuk = true;
      const coords = getCanvasCoordinates(canvas, touch.clientX, touch.clientY);
      
      ctxMasuk.beginPath();
      ctxMasuk.moveTo(coords.x, coords.y);
    }

    function handleTouchMoveMasuk(e) {
      if (!isDrawingMasuk) return;
      e.preventDefault();
      
      const touch = e.touches[0];
      const canvas = e.target;
      const coords = getCanvasCoordinates(canvas, touch.clientX, touch.clientY);
      
      ctxMasuk.lineTo(coords.x, coords.y);
      ctxMasuk.stroke();
    }

    function startDrawingPulang(e) {
      isDrawingPulang = true;
      const canvas = e.target;
      const coords = getCanvasCoordinates(canvas, e.clientX, e.clientY);
      
      ctxPulang.beginPath();
      ctxPulang.moveTo(coords.x, coords.y);
    }

    function drawPulang(e) {
      if (!isDrawingPulang) return;
      
      const canvas = e.target;
      const coords = getCanvasCoordinates(canvas, e.clientX, e.clientY);
      
      ctxPulang.lineTo(coords.x, coords.y);
      ctxPulang.stroke();
    }

    function stopDrawingPulang() {
      isDrawingPulang = false;
    }

    function handleTouchStartPulang(e) {
      e.preventDefault();
      const touch = e.touches[0];
      const canvas = e.target;
      
      isDrawingPulang = true;
      const coords = getCanvasCoordinates(canvas, touch.clientX, touch.clientY);
      
      ctxPulang.beginPath();
      ctxPulang.moveTo(coords.x, coords.y);
    }

    function handleTouchMovePulang(e) {
      if (!isDrawingPulang) return;
      e.preventDefault();
      
      const touch = e.touches[0];
      const canvas = e.target;
      const coords = getCanvasCoordinates(canvas, touch.clientX, touch.clientY);
      
      ctxPulang.lineTo(coords.x, coords.y);
      ctxPulang.stroke();
    }

    function clearCanvasMasuk() {
      const canvas = document.getElementById('canvasMasuk');
      if (canvas && ctxMasuk) {
        ctxMasuk.clearRect(0, 0, canvas.width, canvas.height);
      }
    }

    function clearCanvasPulang() {
      const canvas = document.getElementById('canvasPulang');
      if (canvas && ctxPulang) {
        ctxPulang.clearRect(0, 0, canvas.width, canvas.height);
      }
    }

    function isCanvasBlank(canvas) {
      const context = canvas.getContext('2d');
      const pixelBuffer = new Uint32Array(
        context.getImageData(0, 0, canvas.width, canvas.height).data.buffer
      );
      return !pixelBuffer.some(color => color !== 0);
    }

    function toggleProfilGuru() {
      const content = document.getElementById('profilGuruContent');
      const icon = document.getElementById('profilGuruIcon');
      
      if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        icon.textContent = '?';
      } else {
        content.classList.add('hidden');
        icon.textContent = '?';
      }
    }

    function toggleAkunGuru() {
      const content = document.getElementById('akunGuruContent');
      const icon = document.getElementById('akunGuruIcon');
      
      if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        icon.textContent = '?';
      } else {
        content.classList.add('hidden');
        icon.textContent = '?';
      }
    }

    function updateGuruDashboard() {
      if (!currentUser || currentUser.tipe !== 'guru') return;

      document.getElementById('guruNameDisplay').textContent = currentUser.nama_lengkap;
      document.getElementById('guruSekolahName').textContent = currentUser.nama_sekolah;
      document.getElementById('guruKelasName').textContent = currentUser.kelas;

      const sekolahData = allData.find(d => d.tipe === 'sekolah' && d.npsn === currentUser.npsn);

      document.getElementById('guruProfilNama').textContent = currentUser.nama_lengkap;
      document.getElementById('guruProfilNIP').textContent = currentUser.nip || '-';
      document.getElementById('guruProfilKelas').textContent = currentUser.kelas;
      
      if (sekolahData) {
        document.getElementById('guruProfilSekolah').textContent = sekolahData.nama_sekolah || '-';
      }
      
      initSignatureCanvas();
      tampilkanStatusAbsensi();
    }
    
    function tampilkanStatusAbsensi() {
      if (!currentUser || currentUser.tipe !== 'guru') return;
      
      const today = new Date().toISOString().split('T')[0];
      
      const absenMasukHariIni = allData.find(d => 
        d.tipe === 'absensi_masuk' && 
        d.guru_id === currentUser.__backendId &&
        d.tanggal_absen === today
      );
      
      const absenPulangHariIni = allData.find(d => 
        d.tipe === 'absensi_pulang' && 
        d.guru_id === currentUser.__backendId &&
        d.tanggal_absen === today
      );
      
      const statusMasuk = document.getElementById('statusAbsenMasuk');
      const statusPulang = document.getElementById('statusAbsenPulang');
      const previewMasuk = document.getElementById('previewParafMasuk');
      const previewPulang = document.getElementById('previewParafPulang');
      const imgMasuk = document.getElementById('imgPreviewMasuk');
      const imgPulang = document.getElementById('imgPreviewPulang');
      
      if (absenMasukHariIni) {
        statusMasuk.innerHTML = `<div class="bg-green-100 p-3 rounded-lg">
          <p class="text-green-800 font-semibold">? Sudah absen datang pukul ${absenMasukHariIni.waktu_absen}</p>
        </div>`;
        
        if (absenMasukHariIni.paraf_image) {
          imgMasuk.src = absenMasukHariIni.paraf_image;
          previewMasuk.classList.remove('hidden');
        } else {
          previewMasuk.classList.add('hidden');
        }
      } else {
        statusMasuk.innerHTML = '<p class="text-gray-500 text-xs">Belum absen datang hari ini</p>';
        previewMasuk.classList.add('hidden');
      }
      
      if (absenPulangHariIni) {
        statusPulang.innerHTML = `<div class="bg-orange-100 p-3 rounded-lg">
          <p class="text-orange-800 font-semibold">? Sudah absen pulang pukul ${absenPulangHariIni.waktu_absen}</p>
        </div>`;
        
        if (absenPulangHariIni.paraf_image) {
          imgPulang.src = absenPulangHariIni.paraf_image;
          previewPulang.classList.remove('hidden');
        } else {
          previewPulang.classList.add('hidden');
        }
      } else {
        statusPulang.innerHTML = '<p class="text-gray-500 text-xs">Belum absen pulang hari ini</p>';
        previewPulang.classList.add('hidden');
      }
    }

    async function changeGuruPassword() {
      const newPassword = document.getElementById('guruChangePassword').value;
      if (!newPassword) {
        showToast('?? Password baru harus diisi!', 'error');
        return;
      }

      showToast('? Mengubah password...', 'info');

      const updatedUser = {
        ...currentUser,
        password: newPassword
      };

      const result = await window.dataSdk.update(updatedUser);

      if (result.isOk) {
        currentUser = updatedUser;
        showToast('? Password berhasil diubah!', 'success');
        document.getElementById('guruChangePassword').value = '';
      } else {
        showToast('? Gagal mengubah password!', 'error');
      }
    }

    async function submitAbsenMasukGuru() {
      if (!currentUser || currentUser.tipe !== 'guru') {
        showToast('?? Hanya guru yang bisa absen!', 'error');
        return;
      }

      if (!sdkInitialized) {
        showToast('?? Tunggu sebentar, sistem sedang memuat...', 'error');
        return;
      }

      if (allData.length >= 999) {
        showToast('?? Maksimum 999 data tercapai', 'error');
        return;
      }

      const canvas = document.getElementById('canvasMasuk');
      if (!canvas) {
        showToast('?? Canvas tidak ditemukan!', 'error');
        return;
      }

      if (isCanvasBlank(canvas)) {
        showToast('?? Silakan buat tanda tangan terlebih dahulu!', 'error');
        return;
      }

      const now = new Date();
      const today = now.toISOString().split('T')[0];
      const time = now.toTimeString().split(' ')[0];
      const hour = now.getHours();
      const minute = now.getMinutes();
      const dayOfWeek = now.getDay();
      
      // Validasi hari Minggu
      if (dayOfWeek === 0) {
        showToast('?? Hari Minggu tidak ada absensi!', 'error');
        return;
      }
      
      // Cek apakah sudah absen hari ini
      const existingAbsenMasuk = allData.find(d => 
        d.tipe === 'absensi_masuk' && 
        d.guru_id === currentUser.__backendId &&
        d.tanggal_absen === today
      );

      if (existingAbsenMasuk) {
        showToast(`? Anda sudah absen datang hari ini pukul ${existingAbsenMasuk.waktu_absen}`, 'error');
        return;
      }
      
      // Validasi waktu absen datang: 06:00 - 08:30 WIB
      if (hour < 6) {
        showToast('?? Belum waktunya absen datang! Waktu absen: 06:00 - 08:30 WIB', 'error');
        return;
      }
      
      if (hour > 8 || (hour === 8 && minute > 30)) {
        showToast('? Waktu absen datang sudah berakhir! Batas: 08:30 WIB', 'error');
        return;
      }

      showToast('? Menyimpan absensi datang...', 'info');

      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = 120;
      tempCanvas.height = 50;
      const tempCtx = tempCanvas.getContext('2d');
      
      tempCtx.fillStyle = '#FFFFFF';
      tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
      
      tempCtx.drawImage(canvas, 0, 0, tempCanvas.width, tempCanvas.height);
      
      const parafImage = tempCanvas.toDataURL('image/jpeg', 0.2);

      const newAbsen = {
        tipe: 'absensi_masuk',
        guru_id: currentUser.__backendId,
        nama_lengkap: currentUser.nama_lengkap,
        nip: currentUser.nip || '',
        kelas: currentUser.kelas,
        golongan: currentUser.golongan || '',
        npsn: currentUser.npsn,
        nama_sekolah: currentUser.nama_sekolah,
        tanggal_absen: today,
        waktu_absen: time,
        status_absen: 'masuk',
        paraf_image: parafImage
      };

      const result = await window.dataSdk.create(newAbsen);

      if (result.isOk) {
        showToast(`? Absen datang tersimpan pukul ${time}!`, 'success');
        clearCanvasMasuk();
        tampilkanStatusAbsensi();
      } else {
        showToast('? Gagal menyimpan absensi: ' + (result.error?.message || 'Unknown error'), 'error');
      }
    }

    async function submitAbsenPulangGuru() {
      if (!currentUser || currentUser.tipe !== 'guru') {
        showToast('?? Hanya guru yang bisa absen!', 'error');
        return;
      }

      if (!sdkInitialized) {
        showToast('?? Tunggu sebentar, sistem sedang memuat...', 'error');
        return;
      }

      if (allData.length >= 999) {
        showToast('?? Maksimum 999 data tercapai', 'error');
        return;
      }

      const canvas = document.getElementById('canvasPulang');
      if (!canvas) {
        showToast('?? Canvas tidak ditemukan!', 'error');
        return;
      }

      if (isCanvasBlank(canvas)) {
        showToast('?? Silakan buat tanda tangan terlebih dahulu!', 'error');
        return;
      }

      const now = new Date();
      const today = now.toISOString().split('T')[0];
      const time = now.toTimeString().split(' ')[0];
      const hour = now.getHours();
      const minute = now.getMinutes();
      const dayOfWeek = now.getDay();
      
      // Validasi hari Minggu
      if (dayOfWeek === 0) {
        showToast('?? Hari Minggu tidak ada absensi!', 'error');
        return;
      }
      
      // Validasi libur nasional
      if (isLiburNasional(today)) {
        showToast('?? Hari ini adalah Libur Nasional, tidak ada absensi!', 'error');
        return;
      }
      
      // Cek apakah sudah absen pulang hari ini
      const existingAbsenPulang = allData.find(d => 
        d.tipe === 'absensi_pulang' && 
        d.guru_id === currentUser.__backendId &&
        d.tanggal_absen === today
      );

      if (existingAbsenPulang) {
        showToast(`? Anda sudah absen pulang hari ini pukul ${existingAbsenPulang.waktu_absen}`, 'error');
        return;
      }
      
      // Validasi waktu absen pulang
      // Jumat: 10:00 - 13:00 WIB
      // Hari lain: 11:00 - 13:00 WIB
      if (dayOfWeek === 5) {
        // Hari Jumat
        if (hour < 10) {
          showToast('? Belum waktunya absen pulang! Waktu absen Jumat: 10:00 - 13:00 WIB', 'error');
          return;
        }
      } else {
        // Hari lain (Senin-Kamis, Sabtu)
        if (hour < 11) {
          showToast('? Belum waktunya absen pulang! Waktu absen: 11:00 - 13:00 WIB', 'error');
          return;
        }
      }
      
      if (hour > 13) {
        showToast('? Waktu absen pulang sudah berakhir! Batas: 13:00 WIB', 'error');
        return;
      }

      showToast('? Menyimpan absensi pulang...', 'info');

      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = 120;
      tempCanvas.height = 50;
      const tempCtx = tempCanvas.getContext('2d');
      
      tempCtx.fillStyle = '#FFFFFF';
      tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
      
      tempCtx.drawImage(canvas, 0, 0, tempCanvas.width, tempCanvas.height);
      
      const parafImage = tempCanvas.toDataURL('image/jpeg', 0.2);

      const newAbsen = {
        tipe: 'absensi_pulang',
        guru_id: currentUser.__backendId,
        nama_lengkap: currentUser.nama_lengkap,
        nip: currentUser.nip || '',
        kelas: currentUser.kelas,
        golongan: currentUser.golongan || '',
        npsn: currentUser.npsn,
        nama_sekolah: currentUser.nama_sekolah,
        tanggal_absen: today,
        waktu_absen: time,
        status_absen: 'pulang',
        paraf_image: parafImage
      };

      const result = await window.dataSdk.create(newAbsen);

      if (result.isOk) {
        showToast(`? Absen pulang tersimpan pukul ${time}!`, 'success');
        clearCanvasPulang();
        tampilkanStatusAbsensi();
      } else {
        showToast('? Gagal menyimpan absensi: ' + (result.error?.message || 'Unknown error'), 'error');
      }
    }

    function updateRekapAbsen() {
      if (!currentUser || currentUser.tipe !== 'sekolah') return;

      let guruList = allData.filter(d => d.tipe === 'guru' && d.npsn === currentUser.npsn);
      
      guruList.sort((a, b) => {
        const orderA = a.urutan_absen !== undefined && a.urutan_absen !== null ? parseInt(a.urutan_absen) : 999999;
        const orderB = b.urutan_absen !== undefined && b.urutan_absen !== null ? parseInt(b.urutan_absen) : 999999;
        return orderA - orderB;
      });
      
      let absensiDatangList = allData.filter(d => d.tipe === 'absensi_masuk' && d.npsn === currentUser.npsn);
      let absensiPulangList = allData.filter(d => d.tipe === 'absensi_pulang' && d.npsn === currentUser.npsn);
      
      const now = new Date();
      const namaBulan = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
      const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();

      document.getElementById('kopSekolahDatang').textContent = currentUser.nama_sekolah || '-';
      document.getElementById('alamatSekolahDatang').textContent = currentUser.alamat_sekolah || '-';
      
      document.getElementById('kopSekolahPulang').textContent = currentUser.nama_sekolah || '-';
      document.getElementById('alamatSekolahPulang').textContent = currentUser.alamat_sekolah || '-';
      
      document.getElementById('kopSekolahRekap').textContent = currentUser.nama_sekolah || '-';
      document.getElementById('alamatSekolahRekap').textContent = currentUser.alamat_sekolah || '-';

      renderTabelParafDatang(guruList, absensiDatangList, now, namaBulan, daysInMonth);
      
      renderTabelParafPulang(guruList, absensiPulangList, now, namaBulan, daysInMonth);
      
      renderTabelRekapGabungan(guruList, absensiDatangList, now, namaBulan, daysInMonth);

      const tempatTanggal = currentUser.tempat_ttd && currentUser.tanggal_ttd 
        ? `${currentUser.tempat_ttd}, ${currentUser.tanggal_ttd}`
        : '-';
      document.getElementById('ttdKepalaSekolahText').textContent = tempatTanggal;

      document.getElementById('namaKepalaSekolahText').textContent = currentUser.nama_kepala_sekolah || '-';
      document.getElementById('nipKepalaSekolahText').textContent = currentUser.nip_kepala ? `NIP. ${currentUser.nip_kepala}` : '-';
    }
    
    function renderTabelParafDatang(guruList, absensiList, now, namaBulan, daysInMonth) {
      const tableBody = document.getElementById('rekapAbsenDatangTableBody');
      const headerTanggal = document.getElementById('rekapTanggalHeaderDatang');

      if (!tableBody || !headerTanggal) return;

      document.getElementById('rekapBulanTahunDatang').textContent = `Bulan ${namaBulan[now.getMonth()]} ${now.getFullYear()}`;

      let headerHtml = '';
      for (let day = 1; day <= daysInMonth; day++) {
        headerHtml += `<th class="px-2 py-2 text-center text-xs font-semibold border border-gray-300">${day}</th>`;
      }
      headerTanggal.innerHTML = headerHtml;

      if (guruList.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="${3 + daysInMonth}" class="px-6 py-8 text-center text-gray-500">Belum ada data absensi</td></tr>`;
        return;
      }

      let html = '';
      guruList.forEach((guru, index) => {
        html += `<tr class="border border-gray-300 hover:bg-gray-50">
          <td class="px-4 py-3 text-sm text-center border border-gray-300">${index + 1}</td>
          <td class="px-4 py-3 text-sm border border-gray-300">
            <div class="font-semibold">${guru.nama_lengkap}</div>
            <div class="text-xs text-gray-500">${guru.nip || '-'}</div>
          </td>
          <td class="px-4 py-3 text-sm text-center border border-gray-300">${guru.golongan || '-'}</td>`;

        for (let day = 1; day <= daysInMonth; day++) {
          const date = new Date(now.getFullYear(), now.getMonth(), day);
          const dayOfWeek = date.getDay();
          const dateString = date.toISOString().split('T')[0];
          
          if (dayOfWeek === 0) {
            if (index === 0) {
              html += `<td class="px-2 py-3 text-center text-xs bg-red-100 border border-gray-300 font-semibold text-red-700" rowspan="${guruList.length}" style="writing-mode: vertical-rl; text-orientation: mixed; padding: 20px 5px;">Minggu</td>`;
            }
          } else {
            const absenHariIni = absensiList.find(a => 
              a.guru_id === guru.__backendId && 
              a.tanggal_absen === dateString
            );

            if (absenHariIni && absenHariIni.paraf_image) {
              html += `<td class="px-2 py-3 text-center border border-gray-300 bg-green-50">
                <img src="${absenHariIni.paraf_image}" alt="Paraf" style="width: 60px; height: 30px; margin: 0 auto; display: block;" />
              </td>`;
            } else {
              html += `<td class="px-2 py-3 text-center text-xs border border-gray-300"></td>`;
            }
          }
        }

        html += `</tr>`;
      });

      tableBody.innerHTML = html;
    }
    
    function renderTabelParafPulang(guruList, absensiList, now, namaBulan, daysInMonth) {
      const tableBody = document.getElementById('rekapAbsenPulangTableBody');
      const headerTanggal = document.getElementById('rekapTanggalHeaderPulang');

      if (!tableBody || !headerTanggal) return;

      document.getElementById('rekapBulanTahunPulang').textContent = `Bulan ${namaBulan[now.getMonth()]} ${now.getFullYear()}`;

      let headerHtml = '';
      for (let day = 1; day <= daysInMonth; day++) {
        headerHtml += `<th class="px-2 py-2 text-center text-xs font-semibold border border-gray-300">${day}</th>`;
      }
      headerTanggal.innerHTML = headerHtml;

      if (guruList.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="${3 + daysInMonth}" class="px-6 py-8 text-center text-gray-500">Belum ada data absensi</td></tr>`;
        return;
      }

      let html = '';
      guruList.forEach((guru, index) => {
        html += `<tr class="border border-gray-300 hover:bg-gray-50">
          <td class="px-4 py-3 text-sm text-center border border-gray-300">${index + 1}</td>
          <td class="px-4 py-3 text-sm border border-gray-300">
            <div class="font-semibold">${guru.nama_lengkap}</div>
            <div class="text-xs text-gray-500">${guru.nip || '-'}</div>
          </td>
          <td class="px-4 py-3 text-sm text-center border border-gray-300">${guru.golongan || '-'}</td>`;

        for (let day = 1; day <= daysInMonth; day++) {
          const date = new Date(now.getFullYear(), now.getMonth(), day);
          const dayOfWeek = date.getDay();
          const dateString = date.toISOString().split('T')[0];
          
          if (dayOfWeek === 0) {
            if (index === 0) {
              html += `<td class="px-2 py-3 text-center text-xs bg-red-100 border border-gray-300 font-semibold text-red-700" rowspan="${guruList.length}" style="writing-mode: vertical-rl; text-orientation: mixed; padding: 20px 5px;">Minggu</td>`;
            }
          } else {
            const absenHariIni = absensiList.find(a => 
              a.guru_id === guru.__backendId && 
              a.tanggal_absen === dateString
            );

            if (absenHariIni && absenHariIni.paraf_image) {
              html += `<td class="px-2 py-3 text-center border border-gray-300 bg-orange-50">
                <img src="${absenHariIni.paraf_image}" alt="Paraf" style="width: 60px; height: 30px; margin: 0 auto; display: block;" />
              </td>`;
            } else {
              html += `<td class="px-2 py-3 text-center text-xs border border-gray-300"></td>`;
            }
          }
        }

        html += `</tr>`;
      });

      tableBody.innerHTML = html;
    }
    
    function renderTabelRekapGabungan(guruList, absensiList, now, namaBulan, daysInMonth) {
      const tableBody = document.getElementById('rekapAbsenTableBody');
      const headerTanggal = document.getElementById('rekapTanggalHeader');

      if (!tableBody || !headerTanggal) return;

      document.getElementById('rekapBulanTahun').textContent = `Bulan ${namaBulan[now.getMonth()]} ${now.getFullYear()}`;

      let headerHtml = '';
      for (let day = 1; day <= daysInMonth; day++) {
        headerHtml += `<th class="px-2 py-2 text-center text-xs font-semibold border border-gray-300">${day}</th>`;
      }
      headerTanggal.innerHTML = headerHtml;

      if (guruList.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="${3 + daysInMonth}" class="px-6 py-8 text-center text-gray-500">Belum ada data absensi</td></tr>`;
        return;
      }

      let html = '';
      guruList.forEach((guru, index) => {
        html += `<tr class="border border-gray-300 hover:bg-gray-50">
          <td class="px-4 py-3 text-sm text-center border border-gray-300">${index + 1}</td>
          <td class="px-4 py-3 text-sm border border-gray-300">
            <div class="font-semibold">${guru.nama_lengkap}</div>
            <div class="text-xs text-gray-500">${guru.nip || '-'}</div>
          </td>
          <td class="px-4 py-3 text-sm text-center border border-gray-300">${guru.golongan || '-'}</td>`;

        for (let day = 1; day <= daysInMonth; day++) {
          const date = new Date(now.getFullYear(), now.getMonth(), day);
          const dayOfWeek = date.getDay();
          const dateString = date.toISOString().split('T')[0];
          
          if (dayOfWeek === 0) {
            if (index === 0) {
              html += `<td class="px-2 py-3 text-center text-xs bg-red-100 border border-gray-300 font-semibold text-red-700" rowspan="${guruList.length}" style="writing-mode: vertical-rl; text-orientation: mixed; padding: 20px 5px;">Minggu</td>`;
            }
          } else {
            const absenHariIni = absensiList.find(a => 
              a.guru_id === guru.__backendId && 
              a.tanggal_absen === dateString
            );

            if (absenHariIni) {
              const jamAbsen = absenHariIni.waktu_absen.substring(0, 5);
              html += `<td class="px-2 py-3 text-center text-xs border border-gray-300 bg-green-50 font-semibold" style="color: #15803d;">${jamAbsen}</td>`;
            } else {
              html += `<td class="px-2 py-3 text-center text-xs border border-gray-300"></td>`;
            }
          }
        }

        html += `</tr>`;
      });

      tableBody.innerHTML = html;
    }

    function cetakTabelParafDatang() {
      const printWindow = window.open('', '_blank');
      
      if (!printWindow) {
        showToast('? Pop-up diblokir! Izinkan pop-up untuk mencetak', 'error');
        return;
      }

      let guruList = allData.filter(d => d.tipe === 'guru' && d.npsn === currentUser.npsn);
      
      guruList.sort((a, b) => {
        const orderA = a.urutan_absen !== undefined && a.urutan_absen !== null ? parseInt(a.urutan_absen) : 999999;
        const orderB = b.urutan_absen !== undefined && b.urutan_absen !== null ? parseInt(b.urutan_absen) : 999999;
        return orderA - orderB;
      });
      
      let absensiList = allData.filter(d => d.tipe === 'absensi_masuk' && d.npsn === currentUser.npsn);
      
      const now = new Date();
      const namaBulan = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
      const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();

      let headerHtml = '';
      for (let day = 1; day <= daysInMonth; day++) {
        headerHtml += `<th class="border border-gray-800 px-2 py-2 text-center text-xs font-semibold">${day}</th>`;
      }

      let bodyHtml = '';
      guruList.forEach((guru, index) => {
        bodyHtml += `<tr class="border border-gray-800">
          <td class="border border-gray-800 px-4 py-3 text-sm text-center">${index + 1}</td>
          <td class="border border-gray-800 px-4 py-3 text-sm">
            <div class="font-semibold">${guru.nama_lengkap}</div>
            <div style="font-size: 10px; color: #666;">${guru.nip || '-'}</div>
          </td>
          <td class="border border-gray-800 px-4 py-3 text-sm text-center">${guru.golongan || '-'}</td>`;

        for (let day = 1; day <= daysInMonth; day++) {
          const date = new Date(now.getFullYear(), now.getMonth(), day);
          const dayOfWeek = date.getDay();
          const dateString = date.toISOString().split('T')[0];
          
          if (dayOfWeek === 0) {
            if (index === 0) {
              bodyHtml += `<td class="border border-gray-800 px-2 py-3 text-center text-xs bg-red-100 font-semibold text-red-700" rowspan="${guruList.length}" style="writing-mode: vertical-rl; text-orientation: mixed; padding: 20px 5px;">Minggu</td>`;
            }
          } else {
            const absenHariIni = absensiList.find(a => 
              a.guru_id === guru.__backendId && 
              a.tanggal_absen === dateString
            );

            if (absenHariIni && absenHariIni.paraf_image) {
              bodyHtml += `<td class="border border-gray-800 px-2 py-3 text-center bg-green-50">
                <img src="${absenHariIni.paraf_image}" alt="Paraf" style="width: 60px; height: 30px; margin: 0 auto; display: block;" />
              </td>`;
            } else {
              bodyHtml += `<td class="border border-gray-800 px-2 py-3 text-center text-xs"></td>`;
            }
          }
        }

        bodyHtml += `</tr>`;
      });

      const tempatTanggal = currentUser.tempat_ttd && currentUser.tanggal_ttd 
        ? `${currentUser.tempat_ttd}, ${currentUser.tanggal_ttd}`
        : '-';

      const htmlContent = `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="UTF-8">
          <title>Paraf Datang - ${currentUser.nama_sekolah}</title>
          <style>
            @page { size: landscape; margin: 1cm; }
            body { font-family: Arial, sans-serif; margin: 20px; }
            .judul { text-align: center; margin-bottom: 20px; }
            .judul h3 { margin: 5px 0; font-size: 16px; font-weight: bold; text-transform: uppercase; }
            .judul p { margin: 0; font-size: 12px; color: #555; }
            table { width: 100%; border-collapse: collapse; margin-bottom: 30px; font-size: 10px; }
            th, td { border: 1px solid #000; padding: 6px; }
            th { background-color: #059669; color: white; font-weight: bold; }
            .text-center { text-align: center; }
            .bg-red { background-color: #fee; color: #c00; font-weight: bold; }
            .bg-green { background-color: #efe; color: #070; font-weight: bold; }
            .ttd-section { margin-top: 40px; display: flex; justify-content: flex-end; }
            .ttd-box { text-align: center; min-width: 250px; }
            .ttd-box p { margin: 5px 0; font-size: 12px; }
            .ttd-box .nama { font-weight: bold; margin-top: 100px; padding-top: 10px; }
            .footer-credit { text-align: center; margin-top: 30px; font-size: 11px; color: #1e3a8a; font-weight: bold; }
            @media print {
              body { margin: 0; }
              .no-print { display: none; }
            }
          </style>
        </head>
        <body>
          <div class="judul">
            <h3>${currentUser.nama_sekolah || '-'}</h3>
            <p>${currentUser.alamat_sekolah || '-'}</p>
            <h3 style="margin-top: 20px;">Daftar Hadir Guru</h3>
            <p>Bulan ${namaBulan[now.getMonth()]} ${now.getFullYear()}</p>
          </div>

          <table>
            <thead>
              <tr>
                <th rowspan="2">No</th>
                <th rowspan="2">Nama Guru</th>
                <th rowspan="2">Gol</th>
                <th colspan="${daysInMonth}">Tanggal</th>
              </tr>
              <tr>${headerHtml}</tr>
            </thead>
            <tbody>
              ${bodyHtml}
            </tbody>
          </table>

          <div class="ttd-section">
            <div class="ttd-box">
              <p>${tempatTanggal}</p>
              <p style="font-weight: bold;">Kepala Sekolah,</p>
              <div style="height:100px;"></div>
              <div class="nama">
                <p style="font-weight: bold;">${currentUser.nama_kepala_sekolah || '-'}</p>
                <p style="font-size: 11px;">${currentUser.nip_kepala ? 'NIP. ' + currentUser.nip_kepala : '-'}</p>
              </div>
            </div>
          </div>

          <div class="footer-credit">By. Mujiono, SDN 20 TBT@2025</div>

          <div class="no-print" style="margin-top: 30px; text-align: center;">
            <button onclick="window.print()" style="background: #059669; color: white; padding: 12px 30px; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; margin-right: 10px;">??? Cetak</button>
            <button onclick="window.close()" style="background: #6b7280; color: white; padding: 12px 30px; border: none; border-radius: 8px; font-size: 14px; cursor: pointer;">Tutup</button>
          </div>
        </body>
        </html>
      `;

      printWindow.document.write(htmlContent);
      printWindow.document.close();
      
      showToast('? Jendela cetak dibuka!', 'success');
    }
    
    function cetakTabelParafPulang() {
      const printWindow = window.open('', '_blank');
      
      if (!printWindow) {
        showToast('? Pop-up diblokir! Izinkan pop-up untuk mencetak', 'error');
        return;
      }

      let guruList = allData.filter(d => d.tipe === 'guru' && d.npsn === currentUser.npsn);
      
      guruList.sort((a, b) => {
        const orderA = a.urutan_absen !== undefined && a.urutan_absen !== null ? parseInt(a.urutan_absen) : 999999;
        const orderB = b.urutan_absen !== undefined && b.urutan_absen !== null ? parseInt(b.urutan_absen) : 999999;
        return orderA - orderB;
      });
      
      let absensiList = allData.filter(d => d.tipe === 'absensi_pulang' && d.npsn === currentUser.npsn);
      
      const now = new Date();
      const namaBulan = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
      const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();

      let headerHtml = '';
      for (let day = 1; day <= daysInMonth; day++) {
        headerHtml += `<th class="border border-gray-800 px-2 py-2 text-center text-xs font-semibold">${day}</th>`;
      }

      let bodyHtml = '';
      guruList.forEach((guru, index) => {
        bodyHtml += `<tr class="border border-gray-800">
          <td class="border border-gray-800 px-4 py-3 text-sm text-center">${index + 1}</td>
          <td class="border border-gray-800 px-4 py-3 text-sm">
            <div class="font-semibold">${guru.nama_lengkap}</div>
            <div style="font-size: 10px; color: #666;">${guru.nip || '-'}</div>
          </td>
          <td class="border border-gray-800 px-4 py-3 text-sm text-center">${guru.golongan || '-'}</td>`;

        for (let day = 1; day <= daysInMonth; day++) {
          const date = new Date(now.getFullYear(), now.getMonth(), day);
          const dayOfWeek = date.getDay();
          const dateString = date.toISOString().split('T')[0];
          
          if (dayOfWeek === 0) {
            if (index === 0) {
              bodyHtml += `<td class="border border-gray-800 px-2 py-3 text-center text-xs bg-red-100 font-semibold text-red-700" rowspan="${guruList.length}" style="writing-mode: vertical-rl; text-orientation: mixed; padding: 20px 5px;">Minggu</td>`;
            }
          } else {
            const absenHariIni = absensiList.find(a => 
              a.guru_id === guru.__backendId && 
              a.tanggal_absen === dateString
            );

            if (absenHariIni && absenHariIni.paraf_image) {
              bodyHtml += `<td class="border border-gray-800 px-2 py-3 text-center bg-orange-50">
                <img src="${absenHariIni.paraf_image}" alt="Paraf" style="width: 60px; height: 30px; margin: 0 auto; display: block;" />
              </td>`;
            } else {
              bodyHtml += `<td class="border border-gray-800 px-2 py-3 text-center text-xs"></td>`;
            }
          }
        }

        bodyHtml += `</tr>`;
      });

      const tempatTanggal = currentUser.tempat_ttd && currentUser.tanggal_ttd 
        ? `${currentUser.tempat_ttd}, ${currentUser.tanggal_ttd}`
        : '-';

      const htmlContent = `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="UTF-8">
          <title>Paraf Pulang - ${currentUser.nama_sekolah}</title>
          <style>
            @page { size: landscape; margin: 1cm; }
            body { font-family: Arial, sans-serif; margin: 20px; }
            .judul { text-align: center; margin-bottom: 20px; }
            .judul h3 { margin: 5px 0; font-size: 16px; font-weight: bold; text-transform: uppercase; }
            .judul p { margin: 0; font-size: 12px; color: #555; }
            table { width: 100%; border-collapse: collapse; margin-bottom: 30px; font-size: 10px; }
            th, td { border: 1px solid #000; padding: 6px; }
            th { background-color: #ea580c; color: white; font-weight: bold; }
            .text-center { text-align: center; }
            .bg-red { background-color: #fee; color: #c00; font-weight: bold; }
            .bg-orange { background-color: #fed7aa; color: #c2410c; font-weight: bold; }
            .ttd-section { margin-top: 40px; display: flex; justify-content: flex-end; }
            .ttd-box { text-align: center; min-width: 250px; }
            .ttd-box p { margin: 5px 0; font-size: 12px; }
            .ttd-box .nama { font-weight: bold; margin-top: 100px; padding-top: 10px; }
            .footer-credit { text-align: center; margin-top: 30px; font-size: 11px; color: #1e3a8a; font-weight: bold; }
            @media print {
              body { margin: 0; }
              .no-print { display: none; }
            }
          </style>
        </head>
        <body>
          <div class="judul">
            <h3>${currentUser.nama_sekolah || '-'}</h3>
            <p>${currentUser.alamat_sekolah || '-'}</p>
            <h3 style="margin-top: 20px;">Daftar Hadir Guru</h3>
            <p>Bulan ${namaBulan[now.getMonth()]} ${now.getFullYear()}</p>
          </div>

          <table>
            <thead>
              <tr>
                <th rowspan="2">No</th>
                <th rowspan="2">Nama Guru</th>
                <th rowspan="2">Gol</th>
                <th colspan="${daysInMonth}">Tanggal</th>
              </tr>
              <tr>${headerHtml}</tr>
            </thead>
            <tbody>
              ${bodyHtml}
            </tbody>
          </table>

          <div class="ttd-section">
            <div class="ttd-box">
              <p>${tempatTanggal}</p>
              <p style="font-weight: bold;">Kepala Sekolah,</p>
              <div style="height:100px;"></div>
              <div class="nama">
                <p style="font-weight: bold;">${currentUser.nama_kepala_sekolah || '-'}</p>
                <p style="font-size: 11px;">${currentUser.nip_kepala ? 'NIP. ' + currentUser.nip_kepala : '-'}</p>
              </div>
            </div>
          </div>

          <div class="footer-credit">By. Mujiono, SDN 20 TBT@2025</div>

          <div class="no-print" style="margin-top: 30px; text-align: center;">
            <button onclick="window.print()" style="background: #ea580c; color: white; padding: 12px 30px; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; margin-right: 10px;">??? Cetak</button>
            <button onclick="window.close()" style="background: #6b7280; color: white; padding: 12px 30px; border: none; border-radius: 8px; font-size: 14px; cursor: pointer;">Tutup</button>
          </div>
        </body>
        </html>
      `;

      printWindow.document.write(htmlContent);
      printWindow.document.close();
      
      showToast('? Jendela cetak dibuka!', 'success');
    }

    function cetakTabelAbsen() {
      const printWindow = window.open('', '_blank');
      
      if (!printWindow) {
        showToast('? Pop-up diblokir! Izinkan pop-up untuk mencetak', 'error');
        return;
      }

      let guruList = allData.filter(d => d.tipe === 'guru' && d.npsn === currentUser.npsn);
      
      guruList.sort((a, b) => {
        const orderA = a.urutan_absen !== undefined && a.urutan_absen !== null ? parseInt(a.urutan_absen) : 999999;
        const orderB = b.urutan_absen !== undefined && b.urutan_absen !== null ? parseInt(b.urutan_absen) : 999999;
        return orderA - orderB;
      });
      
      let absensiList = allData.filter(d => d.tipe === 'absensi_masuk' && d.npsn === currentUser.npsn);
      
      const now = new Date();
      const namaBulan = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
      const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();

      let headerHtml = '';
      for (let day = 1; day <= daysInMonth; day++) {
        headerHtml += `<th class="border border-gray-800 px-2 py-2 text-center text-xs font-semibold">${day}</th>`;
      }

      let bodyHtml = '';
      guruList.forEach((guru, index) => {
        bodyHtml += `<tr class="border border-gray-800">
          <td class="border border-gray-800 px-4 py-3 text-sm text-center">${index + 1}</td>
          <td class="border border-gray-800 px-4 py-3 text-sm">
            <div class="font-semibold">${guru.nama_lengkap}</div>
            <div style="font-size: 10px; color: #666;">${guru.nip || '-'}</div>
          </td>
          <td class="border border-gray-800 px-4 py-3 text-sm text-center">${guru.golongan || '-'}</td>`;

        for (let day = 1; day <= daysInMonth; day++) {
          const date = new Date(now.getFullYear(), now.getMonth(), day);
          const dayOfWeek = date.getDay();
          const dateString = date.toISOString().split('T')[0];
          
          if (dayOfWeek === 0) {
            if (index === 0) {
              bodyHtml += `<td class="border border-gray-800 px-2 py-3 text-center text-xs bg-red-100 font-semibold text-red-700" rowspan="${guruList.length}" style="writing-mode: vertical-rl; text-orientation: mixed; padding: 20px 5px;">Minggu</td>`;
            }
          } else {
            const absenHariIni = absensiList.find(a => 
              a.guru_id === guru.__backendId && 
              a.tanggal_absen === dateString
            );

            if (absenHariIni) {
              const jamAbsen = absenHariIni.waktu_absen.substring(0, 5);
              bodyHtml += `<td class="border border-gray-800 px-2 py-3 text-center text-xs bg-green-50 font-semibold" style="color: #15803d;">${jamAbsen}</td>`;
            } else {
              bodyHtml += `<td class="border border-gray-800 px-2 py-3 text-center text-xs"></td>`;
            }
          }
        }

        bodyHtml += `</tr>`;
      });

      const tempatTanggal = currentUser.tempat_ttd && currentUser.tanggal_ttd 
        ? `${currentUser.tempat_ttd}, ${currentUser.tanggal_ttd}`
        : '-';

      const htmlContent = `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="UTF-8">
          <title>Rekap Absensi Guru - ${currentUser.nama_sekolah}</title>
          <style>
            @page { size: landscape; margin: 1cm; }
            body { font-family: Arial, sans-serif; margin: 20px; }
            .judul { text-align: center; margin-bottom: 20px; }
            .judul h3 { margin: 5px 0; font-size: 16px; font-weight: bold; text-transform: uppercase; }
            .judul p { margin: 0; font-size: 12px; color: #555; }
            table { width: 100%; border-collapse: collapse; margin-bottom: 30px; font-size: 10px; }
            th, td { border: 1px solid #000; padding: 6px; }
            th { background-color: #059669; color: white; font-weight: bold; }
            .text-center { text-align: center; }
            .bg-red { background-color: #fee; color: #c00; font-weight: bold; }
            .bg-green { background-color: #efe; color: #070; font-weight: bold; }
            .ttd-section { margin-top: 40px; display: flex; justify-content: flex-end; }
            .ttd-box { text-align: center; min-width: 250px; }
            .ttd-box p { margin: 5px 0; font-size: 12px; }
            .ttd-box .nama { font-weight: bold; margin-top: 100px; padding-top: 10px; }
            .footer-credit { text-align: center; margin-top: 30px; font-size: 11px; color: #1e3a8a; font-weight: bold; }
            @media print {
              body { margin: 0; }
              .no-print { display: none; }
            }
          </style>
        </head>
        <body>
          <div class="judul">
            <h3>${currentUser.nama_sekolah || '-'}</h3>
            <p>${currentUser.alamat_sekolah || '-'}</p>
            <h3 style="margin-top: 20px;">Daftar Hadir Guru</h3>
            <p>Bulan ${namaBulan[now.getMonth()]} ${now.getFullYear()}</p>
          </div>

          <table>
            <thead>
              <tr>
                <th rowspan="2">No</th>
                <th rowspan="2">Nama Guru</th>
                <th rowspan="2">Gol</th>
                <th colspan="${daysInMonth}">Tanggal</th>
              </tr>
              <tr>${headerHtml}</tr>
            </thead>
            <tbody>
              ${bodyHtml}
            </tbody>
          </table>

          <div class="ttd-section">
            <div class="ttd-box">
              <p>${tempatTanggal}</p>
              <p style="font-weight: bold;">Kepala Sekolah,</p>
              <div style="height:100px;"></div>
              <div class="nama">
                <p style="font-weight: bold;">${currentUser.nama_kepala_sekolah || '-'}</p>
                <p style="font-size: 11px;">${currentUser.nip_kepala ? 'NIP. ' + currentUser.nip_kepala : '-'}</p>
              </div>
            </div>
          </div>

          <div class="footer-credit">By. Mujiono, SDN 20 TBT@2025</div>

          <div class="no-print" style="margin-top: 30px; text-align: center;">
            <button onclick="window.print()" style="background: #2563eb; color: white; padding: 12px 30px; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; margin-right: 10px;">??? Cetak</button>
            <button onclick="window.close()" style="background: #6b7280; color: white; padding: 12px 30px; border: none; border-radius: 8px; font-size: 14px; cursor: pointer;">Tutup</button>
          </div>
        </body>
        </html>
      `;

      printWindow.document.write(htmlContent);
      printWindow.document.close();
      
      showToast('? Jendela cetak dibuka!', 'success');
    }

    function showToast(message, type) {
      const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        info: 'bg-blue-500'
      };

      const toast = document.createElement('div');
      toast.className = `fixed top-6 left-1/2 transform -translate-x-1/2 ${colors[type] || colors.info} text-white px-6 py-4 rounded-xl shadow-2xl z-50 max-w-md text-center font-medium`;
      toast.textContent = message;
      toast.style.transition = 'opacity 0.3s';

      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => {
          document.body.removeChild(toast);
        }, 300);
      }, 3000);
    }

    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9bff994e3677fd07',t:'MTc2ODc1NTEwNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>